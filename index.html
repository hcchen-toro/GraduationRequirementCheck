<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æµ·é›»æ©Ÿç•¢æ¥­å­¸åˆ†å¯©æŸ¥ç³»çµ± (v5.0 å®Œæ•´ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #004b97; --secondary-color: #f1f3f5; --header-bg: #004b97; --text-color: #333; }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; color: var(--text-color); }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-radius: 12px; }
        
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 25px; border-bottom: 3px solid var(--primary-color); padding-bottom: 15px; }
        
        .status-bar { background: #e9ecef; padding: 12px; border-radius: 6px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .status-ready { color: #198754; font-weight: bold; }
        .status-loading { color: #0d6efd; font-weight: bold; }
        
        .control-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; background: var(--secondary-color); padding: 25px; border-radius: 10px; margin-bottom: 25px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #495057; }
        
        button.btn { padding: 10px 24px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        button.btn:hover { background-color: #003366; }
        button.btn-admin { background-color: #6c757d; font-size: 13px; padding: 6px 12px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 15px; }
        th, td { border: 1px solid #dee2e6; padding: 10px 15px; text-align: left; }
        th { background-color: var(--header-bg); color: white; text-align: center; }
        td { text-align: center; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        
        .pass { color: #198754; font-weight: bold; }
        .fail { color: #dc3545; font-weight: bold; }
        .course-name { text-align: left; }

        .summary-box { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .stat-card { flex: 1; min-width: 140px; background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #90caf9; }
        .stat-val { font-size: 26px; font-weight: bold; color: var(--primary-color); margin-top: 5px; }
        .stat-title { font-size: 14px; color: #555; font-weight: bold; }

        .category-header { margin-top: 40px; border-left: 5px solid var(--primary-color); padding-left: 10px; color: #444; }
        .sub-category { margin-top: 20px; color: #666; font-size: 1.1em; font-weight: bold; margin-bottom: 10px; }

        #admin-panel { display: none; background: #fff3cd; padding: 20px; border: 1px solid #ffeeba; margin-top: 30px; border-radius: 8px; position: relative; }
        .admin-badge { position: absolute; top: -10px; right: 10px; background: #ffc107; padding: 4px 10px; font-size: 12px; border-radius: 4px; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>æ±æµ·é›»æ©Ÿ ç•¢æ¥­å­¸åˆ†å¯©æŸ¥ç³»çµ± <span style="font-size:0.5em; color:#666;">(v5.0 å®Œæ•´ç‰ˆ)</span></h1>

    <div class="status-bar">
        <span id="dbStatus" class="status-loading">â³ æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«...</span>
        <button class="btn btn-admin" onclick="toggleAdmin()">ğŸ”§ ç®¡ç†è€…æ¨¡å¼</button>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <label>1. é¸æ“‡å…¥å­¸å¹´åº¦ (å½±éŸ¿å¿…ä¿®è¦å‰‡)</label>
            <select id="admissionYear" class="form-control" style="padding: 8px; width: 100%; border:1px solid #ccc; border-radius:4px;" onchange="reAnalyzeIfReady()">
                <option value="111">111 å­¸å¹´åº¦</option>
                <option value="112">112 å­¸å¹´åº¦</option>
                <option value="113">113 å­¸å¹´åº¦</option>
                <option value="114">114 å­¸å¹´åº¦</option>
            </select>
        </div>

        <div class="input-group">
            <label>2. ä¸Šå‚³æˆç¸¾å–® (Excel / CSV)</label>
            <input type="file" id="studentFile" accept=".xlsx, .xls, .csv" style="width: 100%;" />
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                æ”¯æ´ .xlsx æ ¼å¼ã€‚ç³»çµ±å°‡è‡ªå‹•åˆ¤è®€å¿…ä¿®ã€åŸºç¤ã€é€šè­˜èˆ‡ç³»é¸ä¿®ã€‚
            </div>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="processFileAndAnalyze()">é–‹å§‹åˆ†æ</button>
            </div>
        </div>
    </div>

    <div id="result-section" class="hidden">
        <div class="summary-box">
            <div class="stat-card">
                <div class="stat-title">å¿…ä¿®å®Œæˆç‡</div>
                <div class="stat-val" id="reqRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">åŸºç¤å­¸åˆ†</div>
                <div class="stat-val" id="basicCredits">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ç³»å¿…ä¿®å­¸åˆ†</div>
                <div class="stat-val" id="reqCredits">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ç³»é¸ä¿®å­¸åˆ†</div>
                <div class="stat-val" id="elecCredits">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">é€šè­˜å­¸åˆ†</div>
                <div class="stat-val" id="genCredits">0</div>
            </div>
            <div class="stat-card" style="background: #e8f5e9; border-color:#c8e6c9;">
                <div class="stat-title">ç¸½å–å¾—å­¸åˆ†</div>
                <div class="stat-val" id="totalCredits">0</div>
            </div>
        </div>
        <div id="tables-container"></div>
    </div>

    <div id="admin-panel">
        <div class="admin-badge">Admin Mode</div>
        <h3>ä¾‹å¤–ç®¡ç†æ§åˆ¶å°</h3>
        <p>è¨­å®šç‰¹æ®Šèª²ç¨‹æ­¸å±¬ (è¼¸å…¥é¸èª²ä»£è™Ÿï¼Œå°‡å¼·åˆ¶è¦†è“‹åˆ¤æ–·é‚è¼¯)</p>
        
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="text" id="exCode" placeholder="é¸èª²ä»£è™Ÿ (å¦‚ 1091)" style="padding: 8px; width: 150px;">
            <select id="exType" style="padding: 8px;">
                <option value="Required">å¼·åˆ¶è¨­ç‚ºï¼šç³»å¿…ä¿®</option>
                <option value="Basic">å¼·åˆ¶è¨­ç‚ºï¼šåŸºç¤èª²ç¨‹</option>
                <option value="Elective">å¼·åˆ¶è¨­ç‚ºï¼šå…¶ä»–é¸ä¿®(ç³»)</option>
                <option value="ElectiveLab">å¼·åˆ¶è¨­ç‚ºï¼šç³»é¸ä¿®å¯¦é©—</option>
                <option value="General">å¼·åˆ¶è¨­ç‚ºï¼šé€šè­˜</option>
            </select>
            <button class="btn" style="padding: 8px 15px; font-size: 14px;" onclick="addException()">æ–°å¢</button>
        </div>

        <div style="margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px;">
            <strong>ç›®å‰çš„ä¾‹å¤–è¦å‰‡ï¼š</strong>
            <ul id="exceptionList" style="list-style: none; padding: 0; margin-top: 5px; font-size: 14px;">
                <li style="color:#666;">(å°šç„¡è¦å‰‡)</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // --- 1. å®šç¾©è¦å‰‡ (RULES) ---
    // å¿…ä¿®åç¨±åš´æ ¼æ¯”å°
    // 112+å­¸å¹´åº¦ç§»é™¤è»Ÿé«”å¯¦ç¿’
    
    const BASE_BASIC_COURSES = [
        "ä¸­æ–‡", "å¤§ä¸€è‹±æ–‡", "å¤§äºŒè‹±æ–‡", "å¤§ä¸€é«”è‚²", "å¤§äºŒé«”è‚²", 
        "å…¨æ°‘åœ‹é˜²æ•™è‚²", "å‹ä½œæ•™è‚²", "AIæ€ç¶­èˆ‡ç¨‹å¼è¨­è¨ˆ", "ç¨‹å¼æ€ç¶­èˆ‡ç”Ÿæˆå¼AI"
    ];

    const CORE_REQUIRED_COURSES = [
        "å¾®ç©åˆ†ç”²ã€ˆä¸€ã€‰", "æ™®é€šç‰©ç†", "ç¨‹å¼è¨­è¨ˆ", "é‚è¼¯è¨­è¨ˆ", "ç·šæ€§ä»£æ•¸", 
        "é‚è¼¯è¨­è¨ˆå¯¦é©—", "å¾®ç©åˆ†ç”²ã€ˆäºŒã€‰", "ç¨‹å¼èªè¨€", 
        "å·¥ç¨‹æ•¸å­¸ï¼ˆâ… ï¼‰", "å·¥ç¨‹æ•¸å­¸ï¼ˆâ…¡ï¼‰", 
        "é›»å­å­¸ï¼ˆâ… ï¼‰", "é›»è·¯å­¸ï¼ˆâ… ï¼‰", "é›»å·¥å¯¦é©—ï¼ˆâ… ï¼‰", 
        "é›»å­å­¸ï¼ˆâ…¡ï¼‰", "é›»è·¯å­¸ï¼ˆâ…¡ï¼‰", "é›»å·¥å¯¦é©—ï¼ˆâ…¡ï¼‰", 
        "é›»ç£å­¸ï¼ˆâ… ï¼‰", "è¨Šè™Ÿèˆ‡ç³»çµ±", "é›»ç£å­¸ï¼ˆâ…¡ï¼‰", 
        "å°ˆé¡Œç ”ç©¶", "å°ˆé¡Œå¯¦ä½œ"
    ];

    const SOFT_LABS = ["å·¥ç¨‹æ•¸å­¸è»Ÿé«”å¯¦ç¿’", "é›»å­é›»è·¯è»Ÿé«”å¯¦ç¿’", "ç³»çµ±è»Ÿé«”å¯¦ç¿’"];

    // å¿…ä¿®ç™½åå–® (ç‰¹å®šç³»é¸ä¿®)
    const DEPT_ELECTIVE_WHITELIST = [
        "Pythonç¨‹å¼è¨­è¨ˆ", 
        "æ•¸ä½ç³»çµ±é››å‹è¨­è¨ˆ"
    ];

    const RULES = {
        "111": {
            basic: [...BASE_BASIC_COURSES],
            required: [...CORE_REQUIRED_COURSES, ...SOFT_LABS]
        },
        "112": {
            basic: [...BASE_BASIC_COURSES],
            required: [...CORE_REQUIRED_COURSES]
        },
        "113": {
            basic: [...BASE_BASIC_COURSES],
            required: [...CORE_REQUIRED_COURSES]
        },
        "114": {
            basic: [...BASE_BASIC_COURSES],
            required: [...CORE_REQUIRED_COURSES]
        }
    };

    // --- å…¨åŸŸè®Šæ•¸ ---
    let courseDatabase = {};
    let parsedStudentData = [];
    let exceptionMap = {};
    let isDbLoaded = false;

    // --- 2. ç³»çµ±åˆå§‹åŒ– ---
    window.onload = async function() {
        const dbStatus = document.getElementById('dbStatus');
        
        // å˜—è©¦è‡ªå‹•è¼‰å…¥ COURSE è³‡æ–™å¤¾
        const years = [111, 112, 113, 114];
        const sems = [1, 2];
        const systems = ['A', 'M']; 
        let filesToFetch = [];

        years.forEach(y => {
            sems.forEach(s => {
                systems.forEach(sys => filesToFetch.push(`${y}${s}${sys}-data.json`));
            });
        });

        let successCount = 0;
        const requests = filesToFetch.map(fileName => 
            fetch(`./COURSE/${fileName}`)
                .then(res => {
                    if(!res.ok) throw new Error("404");
                    return res.json().then(json => ({ fileName, json }));
                })
                .catch(err => null)
        );

        const results = await Promise.all(requests);
        results.forEach(item => {
            if (item) {
                successCount++;
                const match = item.fileName.match(/^(\d{3})(\d)[A-Za-z]/);
                if (match) processJsonToDB(item.json, match[1], match[2]);
            }
        });

        if (successCount > 0) {
            isDbLoaded = true;
            dbStatus.innerText = `âœ… ç³»çµ±å°±ç·’ (å·²è¼‰å…¥ ${successCount} å€‹é–‹èª²æª”)`;
            dbStatus.className = "status-ready";
        } else {
            dbStatus.innerText = "âš ï¸ æœªåµæ¸¬åˆ°é–‹èª²æª” (å°‡ä¾è³´åç¨±èˆ‡ç™½åå–®åˆ¤æ–·)";
            dbStatus.className = "status-loading"; 
        }
    };

    function processJsonToDB(json, year, sem) {
        for (let key in json) {
            const c = json[key];
            const code = c.selection_id || c.course_code;
            if (code) {
                courseDatabase[`${year}-${sem}-${code}`] = c;
            }
        }
    }

    // --- 3. æª”æ¡ˆä¸Šå‚³èˆ‡è§£æ ---
    function processFileAndAnalyze() {
        const fileInput = document.getElementById('studentFile');
        const file = fileInput.files[0];
        if (!file) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = e.target.result;
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                try {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    parsedStudentData = normalizeData(jsonData);
                    analyze();
                } catch (err) {
                    console.error(err);
                    alert("Excel è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ã€‚");
                }
            } else {
                parsedStudentData = parseCSV(data);
                analyze();
            }
        };

        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            reader.readAsBinaryString(file);
        } else {
            reader.readAsText(file);
        }
    }

    function normalizeData(jsonData) {
        return jsonData.map(row => ({
            year: String(row['å­¸å¹´åº¦'] || row['year'] || "").trim(),
            sem: String(row['å­¸æœŸ'] || row['semester'] || "").trim(),
            code: String(row['é¸èª²ä»£è™Ÿ'] || row['code'] || "").trim(),
            name: String(row['ç§‘ç›®åç¨±'] || row['name'] || "").trim(),
            credit: parseFloat(row['å­¸åˆ†'] || row['credits'] || 0),
            gpa: String(row['GPA'] || row['gpa'] || "").trim()
        })).filter(item => item.name);
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const result = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if(!line) continue;
            const cols = line.split(',');
            if (cols.length >= 6) {
                result.push({
                    year: cols[0].trim(),
                    sem: cols[1].trim(),
                    code: cols[2].trim(),
                    name: cols[3].trim(),
                    credit: parseFloat(cols[4]),
                    gpa: cols[5].trim()
                });
            }
        }
        return result;
    }

    // --- 4. æ ¸å¿ƒåˆ†æé‚è¼¯ ---
    function normalizeName(name) {
        if (!name) return "";
        let s = name.trim();
        s = s.replace(/ï¼ˆ/g, "(").replace(/ï¼‰/g, ")");
        s = s.replace(/ã€ˆ/g, "(").replace(/ã€‰/g, ")");
        s = s.replace(/â… /g, "I").replace(/â…¡/g, "II"); 
        return s;
    }

    function isSameName(studentName, ruleName) {
        const n1 = normalizeName(studentName);
        const n2 = normalizeName(ruleName);
        return n1 === n2; 
    }

    function isBasicCourse(name, basicList) {
        const n = normalizeName(name);
        for (let b of basicList) {
            const nb = normalizeName(b);
            if (n.includes(nb)) return true;
        }
        return false;
    }

    function isGeneralCourse(name) {
        const prefixes = ["äººæ–‡", "ç¤¾æœƒ", "è‡ªç„¶", "æ°¸çºŒ", "æ–‡æ˜", "é ˜å°", "è­°é¡Œ"];
        for (let p of prefixes) {
            if (name.startsWith(p + "ï¼š") || name.startsWith(p + ":") || name.includes(p + "é ˜åŸŸ")) return true;
        }
        return false;
    }

    function analyze() {
        if (parsedStudentData.length === 0) return;

        const year = document.getElementById('admissionYear').value;
        const rule = RULES[year];
        
        let credits = { basic: 0, req: 0, elec: 0, gen: 0, total: 0 };
        let resultLists = { 
            basic: [], 
            req: [], 
            elec: [], // å…¶ä»–é¸ä¿® (ç³»é¸ä¿®æ­£èª²)
            elecLab: [], // ç³»é¸ä¿®å¯¦é©—
            gen: [], 
            fail: [] 
        };

        let reqCheckList = rule.required.map(rName => ({ name: rName, matched: false, log: null }));

        parsedStudentData.forEach(record => {
            // åŠæ ¼åˆ¤æ–· (Dä¸åŠæ ¼)
            const passGrades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-'];
            const isPass = passGrades.includes(record.gpa);
            let semDigit = record.sem === 'ä¸Š' ? '1' : (record.sem === 'ä¸‹' ? '2' : record.sem);

            if (!isPass) {
                resultLists.fail.push(record);
                return;
            }

            let category = "Unknown";
            let matchedReq = false;

            // (A) ç®¡ç†è€…ä¾‹å¤–
            if (exceptionMap[record.code]) {
                category = exceptionMap[record.code];
                if (category === 'Required') {
                    for (let r of reqCheckList) {
                        if (!r.matched && isSameName(record.name, r.name)) {
                            r.matched = true; r.log = record; break;
                        }
                    }
                }
            } 
            else {
                // (B) åŸºç¤èª²ç¨‹
                if (isBasicCourse(record.name, rule.basic)) {
                    category = "Basic";
                }
                // (C) ç³»å¿…ä¿® (åš´æ ¼æ¯”å°)
                else {
                    for (let r of reqCheckList) {
                        if (!r.matched && isSameName(record.name, r.name)) {
                            category = "Required";
                            r.matched = true;
                            r.log = record;
                            matchedReq = true;
                            break;
                        }
                    }
                    
                    if (!matchedReq) {
                        // (D) é€šè­˜ (å‰ç¶´åˆ¤æ–·)
                        if (isGeneralCourse(record.name)) {
                            category = "General";
                        }
                        // (E) ç³»é¸ä¿®
                        else {
                            // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œå…¶ä»–é¸ä¿®ã€(åŸ: ä¸€èˆ¬ç³»é¸ä¿®)
                            // å„ªå…ˆæª¢æŸ¥ç™½åå–®
                            let isWhitelisted = false;
                            for (let w of DEPT_ELECTIVE_WHITELIST) {
                                if (record.name.includes(w)) {
                                    isWhitelisted = true;
                                    break;
                                }
                            }

                            if (isWhitelisted) {
                                category = "Elective";
                            } else {
                                // é è¨­ç‚ºç³»é¸ä¿®
                                category = "Elective"; 
                            }
                        }
                    }
                }
            }

            // (F) ç´°åˆ†ç³»é¸ä¿®ï¼šå¯¦é©— vs å…¶ä»–é¸ä¿®
            // ä¿®æ­£é‚è¼¯ï¼šå³ä½¿æ˜¯1å­¸åˆ†+å¯¦ä½œï¼Œå¦‚æœæ˜¯ç‰¹å®šèª²ç¨‹(å¦‚å·¥ç¨‹æ•¸å­¸å¯¦ä½œ)ï¼Œæ‡‰æ­¸é¡ç‚º"å…¶ä»–é¸ä¿®"è€Œé"å¯¦é©—"
            if (category === "Elective" || category === "ElectiveLab") {
                const isLabKeyword = record.name.includes("å¯¦é©—") || record.name.includes("å¯¦ä½œ");
                
                // æ’é™¤åˆ—è¡¨ï¼šé€™äº›èª²é›–ç„¶æœ‰"å¯¦ä½œ"ä¸”1å­¸åˆ†ï¼Œä½†ä½¿ç”¨è€…å®šç¾©ç‚º"å…¶ä»–é¸ä¿®"
                const excludeFromLab = record.name.includes("å·¥ç¨‹æ•¸å­¸") || record.name.includes("é›»è·¯å­¸") || record.name.includes("å¯¦å‹™æ¢ç´¢");

                if (record.credit === 1 && isLabKeyword && !excludeFromLab) {
                    category = "ElectiveLab";
                } else {
                    category = "Elective"; // æ­¸é¡ç‚º å…¶ä»–é¸ä¿®
                }
            }

            // æ­¸æª”
            if (category === "Basic") {
                resultLists.basic.push(record);
                credits.basic += record.credit;
            } else if (category === "Required") {
                resultLists.req.push(record);
                credits.req += record.credit;
            } else if (category === "Elective") {
                resultLists.elec.push(record);
                credits.elec += record.credit;
            } else if (category === "ElectiveLab") {
                resultLists.elecLab.push(record);
                credits.elec += record.credit; // å¯¦é©—ä½µå…¥ç³»é¸ä¿®ç¸½åˆ†
            } else if (category === "General") {
                resultLists.gen.push(record);
                credits.gen += record.credit;
            } else {
                resultLists.elec.push(record);
                credits.elec += record.credit;
            }
            
            credits.total += record.credit;
        });

        updateUI(credits, resultLists, reqCheckList);
    }

    function updateUI(credits, lists, reqCheckList) {
        document.getElementById('result-section').classList.remove('hidden');
        
        document.getElementById('basicCredits').innerText = credits.basic;
        document.getElementById('reqCredits').innerText = credits.req;
        document.getElementById('elecCredits').innerText = credits.elec;
        document.getElementById('genCredits').innerText = credits.gen;
        document.getElementById('totalCredits').innerText = credits.total;

        const passedCount = reqCheckList.filter(r => r.matched).length;
        document.getElementById('reqRate').innerText = Math.round((passedCount / reqCheckList.length) * 100) + "%";

        const container = document.getElementById('tables-container');
        let html = "";

        // 1. åŸºç¤
        html += `<h3 class="category-header">1. åŸºç¤èª²ç¨‹ (Basic Courses)</h3>`;
        html += renderSimpleTable(lists.basic);

        // 2. ç³»å¿…ä¿®
        html += `<h3 class="category-header">2. å­¸ç³»å¿…ä¿®ç§‘ç›® (Department Required)</h3>`;
        html += `<table>
            <thead><tr><th width="40%">å¿…ä¿®ç§‘ç›®åç¨±</th><th width="15%">è¦å®šå­¸åˆ†</th><th width="15%">ç‹€æ…‹</th><th width="30%">ä¿®èª²ç´€éŒ„ (èª²å / æˆç¸¾)</th></tr></thead>
            <tbody>`;
        reqCheckList.forEach(r => {
            const status = r.matched ? '<span class="pass">âœ” é€šé</span>' : '<span class="fail">âœ˜ æœªä¿®</span>';
            const detail = r.log ? `${r.log.name} (${r.log.gpa})` : "-";
            html += `<tr>
                <td style="text-align:left; padding-left:20px;">${r.name}</td>
                <td>-</td> 
                <td>${status}</td>
                <td style="text-align:left;">${detail}</td>
            </tr>`;
        });
        html += `</tbody></table>`;

        // 3. é€šè­˜
        html += `<h3 class="category-header">3. é€šè­˜èª²ç¨‹ (General Education)</h3>`;
        html += renderSimpleTable(lists.gen);

        // 4. ç³»é¸ä¿®
        html += `<h3 class="category-header">4. ç³»é¸ä¿® (Department Elective)</h3>`;
        
        html += `<div class="sub-category">â–¶ ç³»é¸ä¿®å¯¦é©— (Laboratory / 1å­¸åˆ†)</div>`;
        html += renderSimpleTable(lists.elecLab);
        
        // åç¨±èª¿æ•´ï¼šä¸€èˆ¬ç³»é¸ä¿® -> å…¶ä»–é¸ä¿®
        html += `<div class="sub-category">â–¶ å…¶ä»–é¸ä¿® (Other Elective)</div>`;
        html += renderSimpleTable(lists.elec);

        // 5. ä¸åŠæ ¼
        if (lists.fail.length > 0) {
            html += `<h3 class="category-header" style="border-color:#dc3545; color:#dc3545;">âŒ ä¸åŠæ ¼ / æœªé€šé</h3>`;
            html += renderSimpleTable(lists.fail);
        }

        container.innerHTML = html;
    }

    function renderSimpleTable(list) {
        if (list.length === 0) return "<p style='color:#999; margin-left:10px;'>ç„¡èª²ç¨‹è³‡æ–™</p>";
        let h = `<table><thead><tr>
            <th width="60%">ç§‘ç›®åç¨±</th>
            <th width="20%">å­¸åˆ†</th>
            <th width="20%">æˆç¸¾</th>
        </tr></thead><tbody>`;
        
        list.forEach(c => {
            h += `<tr>
                <td class="course-name" style="padding-left:20px;">${c.name}</td>
                <td>${c.credit}</td>
                <td>${c.gpa}</td>
            </tr>`;
        });
        h += `</tbody></table>`;
        return h;
    }

    function reAnalyzeIfReady() {
        if (parsedStudentData.length > 0) analyze();
    }

    // --- 5. ç®¡ç†è€…åŠŸèƒ½ ---
    function toggleAdmin() {
        const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼š");
        if (pwd === "07160330") {
            document.getElementById('admin-panel').style.display = 'block';
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤");
        }
    }

    function addException() {
        const code = document.getElementById('exCode').value.trim();
        const type = document.getElementById('exType').value;
        const typeNames = { 
            "Required": "ç³»å¿…ä¿®", "Basic": "åŸºç¤èª²ç¨‹", 
            "Elective": "å…¶ä»–é¸ä¿®(ç³»)", "ElectiveLab": "ç³»é¸ä¿®å¯¦é©—", "General": "é€šè­˜" 
        };
        
        if (!code) return alert("è«‹è¼¸å…¥é¸èª²ä»£è™Ÿ");

        exceptionMap[code] = type;
        
        const list = document.getElementById('exceptionList');
        if (list.querySelector('li') && list.querySelector('li').innerText === "(å°šç„¡è¦å‰‡)") list.innerHTML = "";
        
        const li = document.createElement('li');
        li.innerHTML = `<strong>${code}</strong> âœ ${typeNames[type]} <button onclick="removeException(this, '${code}')" style="margin-left:10px; color:red; border:none; background:none; cursor:pointer;">[åˆªé™¤]</button>`;
        list.appendChild(li);
        document.getElementById('exCode').value = "";
        
        if (parsedStudentData.length > 0) analyze();
    }

    function removeException(btn, code) {
        delete exceptionMap[code];
        btn.parentElement.remove();
        if (parsedStudentData.length > 0) analyze();
    }
</script>

</body>
</html>
