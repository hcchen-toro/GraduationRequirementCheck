<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æµ·é›»æ©Ÿç•¢æ¥­å­¸åˆ†å¯©æŸ¥ç³»çµ± (v7.0 å„€è¡¨æ¿å‡ç´šç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #004b97; --secondary-color: #f8f9fa; --success-color: #198754; --danger-color: #dc3545; --warning-color: #ffc107; }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1280px; margin: 0 auto; background: #fff; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 12px; }
        
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 30px; border-bottom: 3px solid var(--primary-color); padding-bottom: 15px; }
        
        /* ç‹€æ…‹åˆ— */
        .status-bar { background: #e9ecef; padding: 10px 20px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .status-ready { color: var(--success-color); font-weight: bold; }
        .status-loading { color: #0d6efd; font-weight: bold; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; background: var(--secondary-color); padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #dee2e6; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #495057; }
        .input-group select, .input-group input { padding: 10px; border: 1px solid #ced4da; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        button.btn { padding: 10px 24px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        button.btn:hover { background-color: #003366; }
        button.btn-admin { background-color: #6c757d; font-size: 13px; padding: 6px 12px; }

        /* æ–°ç‰ˆå„€è¡¨æ¿ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .dash-title { font-size: 16px; font-weight: bold; color: #555; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .dash-value { font-size: 28px; font-weight: bold; color: var(--primary-color); }
        .dash-sub { font-size: 13px; color: #777; margin-top: 5px; }
        .dash-status { font-size: 12px; padding: 2px 8px; border-radius: 10px; color: #fff; font-weight: bold; }
        .status-ok { background-color: var(--success-color); }
        .status-ng { background-color: var(--danger-color); }
        .status-warn { background-color: var(--warning-color); color: #333; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 15px; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #dee2e6; padding: 12px 15px; text-align: left; }
        th { background-color: var(--primary-color); color: white; text-align: center; }
        td { text-align: center; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        
        .pass { color: var(--success-color); font-weight: bold; }
        .fail { color: var(--danger-color); font-weight: bold; }
        .course-name { text-align: left; font-weight: 500; }

        .category-header { margin-top: 50px; border-left: 5px solid var(--primary-color); padding-left: 15px; color: #333; font-size: 1.4em; }
        .sub-category { margin-top: 20px; color: #555; font-size: 1.1em; font-weight: bold; margin-bottom: 10px; background: #e9ecef; padding: 8px 12px; border-radius: 6px; display: inline-block; }

        /* ç®¡ç†è€…é¢æ¿ */
        #admin-panel { display: none; background: #fff3cd; padding: 20px; border: 1px solid #ffeeba; margin-top: 30px; border-radius: 8px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>æ±æµ·é›»æ©Ÿ ç•¢æ¥­å­¸åˆ†å¯©æŸ¥ç³»çµ± <span style="font-size:0.5em; color:#666;">(v7.0)</span></h1>

    <div class="status-bar">
        <span id="dbStatus" class="status-loading">â³ æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«...</span>
        <button class="btn btn-admin" onclick="toggleAdmin()">ğŸ”§ ç®¡ç†è€…æ¨¡å¼</button>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <label>1. é¸æ“‡å…¥å­¸å¹´åº¦</label>
            <select id="admissionYear" onchange="reAnalyzeIfReady()">
                <option value="111">111 å­¸å¹´åº¦</option>
                <option value="112">112 å­¸å¹´åº¦</option>
                <option value="113">113 å­¸å¹´åº¦</option>
                <option value="114">114 å­¸å¹´åº¦</option>
            </select>
        </div>

        <div class="input-group">
            <label>2. ä¸Šå‚³æˆç¸¾å–® (Excel / CSV)</label>
            <div style="display: flex; gap: 10px;">
                <input type="file" id="studentFile" accept=".xlsx, .xls, .csv" />
                <button class="btn" onclick="processFileAndAnalyze()">é–‹å§‹åˆ†æ</button>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                æ”¯æ´æ ¼å¼ï¼š.xlsx, .csvã€‚ç³»çµ±å°‡ä¾ç…§å¹´åº¦è¦å‰‡è‡ªå‹•å¯©æ ¸ã€‚
            </div>
        </div>
    </div>

    <div id="result-section" class="hidden">
        
        <h3 style="color:#555; margin-bottom:15px;">ğŸ“Š å­¸åˆ†å¯©æ ¸å„€è¡¨æ¿</h3>
        <div class="dashboard-grid">
            <div class="dash-card">
                <div class="dash-title">åŸºç¤å­¸åˆ† <span id="basicStatus" class="dash-status status-ng">æœªå®Œæˆ</span></div>
                <div class="dash-value"><span id="basicCred">0</span> <span style="font-size:16px; color:#999;">/ 14</span></div>
                <div class="dash-sub">å·²ä¿®é–€æ•¸: <span id="basicCount">0</span> (ç›®æ¨™: ä¸­+è‹±+ç¨‹)</div>
            </div>

            <div class="dash-card">
                <div class="dash-title">ç³»å¿…ä¿® <span id="reqStatus" class="dash-status status-ng">æœªå®Œæˆ</span></div>
                <div class="dash-value"><span id="reqCred">0</span> <span style="font-size:16px; color:#999;">/ <span id="reqTarget">81</span></span></div>
                <div class="dash-sub">å·²ä¿®é–€æ•¸: <span id="reqCount">0</span> / <span id="reqTotalCount">0</span></div>
            </div>

            <div class="dash-card" style="border-left: 5px solid #ffc107;">
                <div class="dash-title">ç³»é¸ä¿® (å«å¯¦é©—) <span id="deptElecStatus" class="dash-status status-ng">æœªé”æ¨™</span></div>
                <div class="dash-value"><span id="deptElecCred">0</span> <span style="font-size:16px; color:#999;">/ 20</span></div>
                <div class="dash-sub" id="labStatusText">å¯¦é©—èª²: 0 é–€ (éœ€ >= 1) âŒ</div>
            </div>

            <div class="dash-card">
                <div class="dash-title">é€šè­˜å­¸åˆ† <span id="genEdStatus" class="dash-status status-ng">æœªå®Œæˆ</span></div>
                <div class="dash-value"><span id="genEdCred">0</span> <span style="font-size:16px; color:#999;">/ 12</span></div>
                <div class="dash-sub">å·²ä¿®é–€æ•¸: <span id="genEdCount">0</span></div>
            </div>

            <div class="dash-card" style="background:#f8f9fa;">
                <div class="dash-title">ç•¢æ¥­ç¸½å­¸åˆ† <span id="gradStatus" class="dash-status status-ng">æœªæ»¿</span></div>
                <div class="dash-value"><span id="totalCred">0</span> <span style="font-size:16px; color:#999;">/ 128</span></div>
                <div class="dash-sub">ä¸€èˆ¬é¸ä¿®: <span id="genElecCred">0</span> å­¸åˆ†</div>
            </div>
        </div>

        <div id="tables-container"></div>
    </div>

    <div id="admin-panel">
        <h3 style="color:#856404;">ğŸ”§ ä¾‹å¤–ç®¡ç† (ä»¥èª²ååˆ¤å®š)</h3>
        <p>è¼¸å…¥èª²ç¨‹åç¨±ï¼Œå¼·åˆ¶æŒ‡å®šå…¶é¡åˆ¥ï¼š</p>
        
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="text" id="exName" placeholder="èª²ç¨‹åç¨± (å¦‚: æ•¸ä½å½±åƒè™•ç†)" style="padding: 8px; width: 250px;">
            <select id="exType" style="padding: 8px;">
                <option value="Required">å¼·åˆ¶è¨­ç‚ºï¼šç³»å¿…ä¿®</option>
                <option value="Basic">å¼·åˆ¶è¨­ç‚ºï¼šåŸºç¤èª²ç¨‹</option>
                <option value="DeptElective">å¼·åˆ¶è¨­ç‚ºï¼šç³»é¸ä¿®</option>
                <option value="DeptElectiveLab">å¼·åˆ¶è¨­ç‚ºï¼šç³»é¸ä¿®å¯¦é©—</option>
                <option value="GeneralElective">å¼·åˆ¶è¨­ç‚ºï¼šä¸€èˆ¬é¸ä¿®</option>
                <option value="GenEd">å¼·åˆ¶è¨­ç‚ºï¼šé€šè­˜</option>
            </select>
            <button class="btn" onclick="addException()">æ–°å¢è¦å‰‡</button>
        </div>

        <div style="margin-top: 15px;">
            <strong>ç›®å‰è¦å‰‡ï¼š</strong>
            <ul id="exceptionList" style="margin-top: 5px;">
                <li style="color:#666;">(ç„¡)</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // --- 1. è¦å‰‡å®šç¾© (RULES) ---
    // ç›®æ¨™å­¸åˆ†è¨­å®š
    const CREDITS_TARGET = {
        "111": { basic: 14, req: 84, deptElec: 20, genEd: 12, total: 128 },
        "112": { basic: 14, req: 81, deptElec: 20, genEd: 12, total: 128 },
        "113": { basic: 14, req: 81, deptElec: 20, genEd: 12, total: 128 },
        "114": { basic: 14, req: 81, deptElec: 20, genEd: 12, total: 128 }
    };

    const BASE_BASIC_COURSES = [
        "ä¸­æ–‡", "å¤§ä¸€è‹±æ–‡", "å¤§äºŒè‹±æ–‡", "å¤§ä¸€é«”è‚²", "å¤§äºŒé«”è‚²", 
        "å…¨æ°‘åœ‹é˜²æ•™è‚²", "å‹ä½œæ•™è‚²", "AIæ€ç¶­èˆ‡ç¨‹å¼è¨­è¨ˆ", "ç¨‹å¼æ€ç¶­èˆ‡ç”Ÿæˆå¼AI"
    ];

    const CORE_REQUIRED_COURSES = [
        "å¾®ç©åˆ†ç”²ã€ˆä¸€ã€‰", "æ™®é€šç‰©ç†", "ç¨‹å¼è¨­è¨ˆ", "é‚è¼¯è¨­è¨ˆ", "ç·šæ€§ä»£æ•¸", 
        "é‚è¼¯è¨­è¨ˆå¯¦é©—", "å¾®ç©åˆ†ç”²ã€ˆäºŒã€‰", "ç¨‹å¼èªè¨€", 
        "å·¥ç¨‹æ•¸å­¸ï¼ˆâ… ï¼‰", "å·¥ç¨‹æ•¸å­¸ï¼ˆâ…¡ï¼‰", 
        "é›»å­å­¸ï¼ˆâ… ï¼‰", "é›»è·¯å­¸ï¼ˆâ… ï¼‰", "é›»å·¥å¯¦é©—ï¼ˆâ… ï¼‰", 
        "é›»å­å­¸ï¼ˆâ…¡ï¼‰", "é›»è·¯å­¸ï¼ˆâ…¡ï¼‰", "é›»å·¥å¯¦é©—ï¼ˆâ…¡ï¼‰", 
        "é›»ç£å­¸ï¼ˆâ… ï¼‰", "è¨Šè™Ÿèˆ‡ç³»çµ±", "é›»ç£å­¸ï¼ˆâ…¡ï¼‰", 
        "å°ˆé¡Œç ”ç©¶", "å°ˆé¡Œå¯¦ä½œ"
    ];

    const SOFT_LABS = ["å·¥ç¨‹æ•¸å­¸è»Ÿé«”å¯¦ç¿’", "é›»å­é›»è·¯è»Ÿé«”å¯¦ç¿’", "ç³»çµ±è»Ÿé«”å¯¦ç¿’"];

    // ç³»é¸ä¿®ç™½åå–®
    const DEPT_ELECTIVE_WHITELIST = ["Pythonç¨‹å¼è¨­è¨ˆ", "æ•¸ä½ç³»çµ±é››å‹è¨­è¨ˆ"];

    // ç³»é¸ä¿®é—œéµå­— (éœ€æ­é…å­¸åˆ†>=3)
    const DEPT_KEYWORDS = [
        "é›»å­", "é›»æ©Ÿ", "é›»è·¯", "è¨Šè™Ÿ", "ç³»çµ±", "åŠå°é«”", "æ™¶ç‰‡", "æ§åˆ¶", 
        "é€šè¨Š", "é‚è¼¯", "å¾®è™•ç†", "ç¨‹å¼", "ç‰©ä»¶å°å‘", "æ¼”ç®—æ³•", "äººå·¥æ™ºæ…§", 
        "æ·±åº¦å­¸ç¿’", "ç©é«”é›»è·¯", "å…‰é›»", "é›»ç£", "å¾®æ³¢", "å¤©ç·š"
    ];

    const RULES = {
        "111": { basic: BASE_BASIC_COURSES, required: [...CORE_REQUIRED_COURSES, ...SOFT_LABS] },
        "112": { basic: BASE_BASIC_COURSES, required: CORE_REQUIRED_COURSES },
        "113": { basic: BASE_BASIC_COURSES, required: CORE_REQUIRED_COURSES },
        "114": { basic: BASE_BASIC_COURSES, required: CORE_REQUIRED_COURSES }
    };

    let parsedStudentData = [];
    let exceptionMap = {}; 
    let courseDatabase = {}; 

    // --- 2. åˆå§‹åŒ– ---
    window.onload = async function() {
        const dbStatus = document.getElementById('dbStatus');
        
        // è¼‰å…¥ COURSE JSON
        const years = [111, 112, 113, 114];
        const sems = [1, 2];
        const systems = ['A', 'M']; 
        let filesToFetch = [];

        years.forEach(y => sems.forEach(s => systems.forEach(sys => filesToFetch.push(`${y}${s}${sys}-data.json`))));

        let successCount = 0;
        const requests = filesToFetch.map(fileName => 
            fetch(`./COURSE/${fileName}`).then(res => res.ok ? res.json().then(j => ({n:fileName, j})) : null).catch(()=>null)
        );

        const results = await Promise.all(requests);
        results.forEach(item => {
            if (item) {
                successCount++;
                const m = item.n.match(/^(\d{3})(\d)[A-Za-z]/);
                if (m) processJsonToDB(item.j, m[1], m[2]);
            }
        });

        if (successCount > 0) {
            dbStatus.innerText = `âœ… ç³»çµ±å°±ç·’ (å·²è¼‰å…¥ ${successCount} å€‹é–‹èª²æª”)`;
            dbStatus.className = "status-ready";
        } else {
            dbStatus.innerText = "âš ï¸ æœªåµæ¸¬åˆ°é–‹èª²æª” (å°‡ä¾è³´åç¨±è¦å‰‡åˆ¤æ–·)";
        }
    };

    function processJsonToDB(json, year, sem) {
        for (let key in json) {
            const c = json[key];
            const code = c.selection_id || c.course_code;
            if (code) courseDatabase[`${year}-${sem}-${code}`] = c;
        }
    }

    // --- 3. æª”æ¡ˆè®€å– ---
    function processFileAndAnalyze() {
        const fileInput = document.getElementById('studentFile');
        const file = fileInput.files[0];
        if (!file) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = e.target.result;
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                try {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });
                    parsedStudentData = normalizeData(jsonData);
                    analyze();
                } catch (err) { alert("Excel è®€å–å¤±æ•—"); }
            } else {
                parsedStudentData = parseCSV(data);
                analyze();
            }
        };

        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) reader.readAsBinaryString(file);
        else reader.readAsText(file);
    }

    function normalizeData(jsonData) {
        return jsonData.map(row => ({
            year: String(row['å­¸å¹´åº¦'] || row['year'] || "").trim(),
            sem: String(row['å­¸æœŸ'] || row['semester'] || "").trim(),
            code: String(row['é¸èª²ä»£è™Ÿ'] || row['code'] || "").trim(),
            name: String(row['ç§‘ç›®åç¨±'] || row['name'] || "").trim(),
            credit: parseFloat(row['å­¸åˆ†'] || row['credits'] || 0),
            gpa: String(row['GPA'] || row['gpa'] || "").trim()
        })).filter(item => item.name);
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const result = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if(!line) continue;
            const cols = line.split(',');
            if (cols.length >= 6) {
                result.push({
                    year: cols[0].trim(),
                    sem: cols[1].trim(),
                    code: cols[2].trim(),
                    name: cols[3].trim(),
                    credit: parseFloat(cols[4]),
                    gpa: cols[5].trim()
                });
            }
        }
        return result;
    }

    // --- 4. æ ¸å¿ƒé‚è¼¯ ---
    function normalizeName(name) {
        if (!name) return "";
        return name.trim().replace(/ï¼ˆ/g, "(").replace(/ï¼‰/g, ")").replace(/ã€ˆ/g, "(").replace(/ã€‰/g, ")").replace(/â… /g, "I").replace(/â…¡/g, "II");
    }

    function isSameName(sName, rName) { return normalizeName(sName) === normalizeName(rName); }

    function isBasicCourse(name, list) {
        const n = normalizeName(name);
        return list.some(b => n.includes(normalizeName(b)));
    }

    function isGeneralEd(name) {
        const p = ["äººæ–‡", "ç¤¾æœƒ", "è‡ªç„¶", "æ°¸çºŒ", "æ–‡æ˜", "é ˜å°", "è­°é¡Œ"];
        return p.some(pre => name.startsWith(pre + "ï¼š") || name.startsWith(pre + ":") || name.includes(pre + "é ˜åŸŸ"));
    }

    function isDeptElective(name, credit) {
        const n = normalizeName(name);
        if (DEPT_ELECTIVE_WHITELIST.some(w => n.includes(normalizeName(w)))) return true;
        if (credit >= 3 && DEPT_KEYWORDS.some(k => n.includes(k))) return true;
        return false;
    }

    function analyze() {
        if (parsedStudentData.length === 0) return;

        const year = document.getElementById('admissionYear').value;
        const rule = RULES[year];
        const target = CREDITS_TARGET[year];
        
        let stats = {
            basic: { cred: 0, count: 0 },
            req: { cred: 0, count: 0 },
            deptElec: { cred: 0, count: 0 }, // å«å¯¦é©—
            deptElecLab: { cred: 0, count: 0 },
            genElec: { cred: 0, count: 0 },
            genEd: { cred: 0, count: 0 },
            total: 0
        };

        let lists = { basic: [], req: [], deptElec: [], deptElecLab: [], genElec: [], genEd: [], fail: [] };
        let reqCheckList = rule.required.map(r => ({ name: r, matched: false, log: null }));

        parsedStudentData.forEach(rec => {
            const passGrades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-'];
            if (!passGrades.includes(rec.gpa)) {
                lists.fail.push(rec);
                return;
            }

            let cat = "Unknown";
            const normName = normalizeName(rec.name);

            // 1. ä¾‹å¤–ç®¡ç†
            if (exceptionMap[normName]) {
                cat = exceptionMap[normName];
                if (cat === 'Required') {
                    for (let r of reqCheckList) {
                        if (!r.matched && isSameName(rec.name, r.name)) { r.matched = true; r.log = rec; break; }
                    }
                }
            } 
            else {
                // 2. åŸºç¤
                if (isBasicCourse(rec.name, rule.basic)) cat = "Basic";
                // 3. å¿…ä¿®
                else {
                    let matched = false;
                    for (let r of reqCheckList) {
                        if (!r.matched && isSameName(rec.name, r.name)) {
                            cat = "Required"; r.matched = true; r.log = rec; matched = true; break;
                        }
                    }
                    if (!matched) {
                        // 4. é€šè­˜
                        if (isGeneralEd(rec.name)) cat = "GenEd";
                        else {
                            // 5. ç³»é¸ä¿®å¯¦é©—
                            const isLabKey = rec.name.includes("å¯¦é©—") || rec.name.includes("å¯¦ä½œ");
                            const exclude = rec.name.includes("å·¥ç¨‹æ•¸å­¸") || rec.name.includes("é›»è·¯å­¸") || rec.name.includes("å¯¦å‹™æ¢ç´¢");
                            if (rec.credit === 1 && isLabKey && !exclude) cat = "DeptElectiveLab";
                            // 6. ç³»é¸ä¿®
                            else if (isDeptElective(rec.name, rec.credit)) cat = "DeptElective";
                            // 7. ä¸€èˆ¬é¸ä¿®
                            else cat = "GeneralElective";
                        }
                    }
                }
            }

            // çµ±è¨ˆ
            stats.total += rec.credit;
            if (cat === "Basic") { lists.basic.push(rec); stats.basic.cred += rec.credit; stats.basic.count++; }
            else if (cat === "Required") { lists.req.push(rec); stats.req.cred += rec.credit; stats.req.count++; }
            else if (cat === "DeptElective") { lists.deptElec.push(rec); stats.deptElec.cred += rec.credit; stats.deptElec.count++; }
            else if (cat === "DeptElectiveLab") { lists.deptElecLab.push(rec); stats.deptElec.cred += rec.credit; stats.deptElecLab.count++; } // å¯¦é©—å­¸åˆ†ç®—å…¥ç³»é¸ä¿®
            else if (cat === "GenEd") { lists.genEd.push(rec); stats.genEd.cred += rec.credit; stats.genEd.count++; }
            else if (cat === "GeneralElective") { lists.genElec.push(rec); stats.genElec.cred += rec.credit; stats.genElec.count++; }
        });

        updateDashboard(stats, target, reqCheckList);
        renderTables(lists, reqCheckList);
    }

    // --- 5. æ›´æ–°å„€è¡¨æ¿ ---
    function updateDashboard(stats, target, reqCheckList) {
        document.getElementById('result-section').classList.remove('hidden');

        // 1. åŸºç¤
        updateCard('basic', stats.basic.cred, target.basic, stats.basic.count);

        // 2. å¿…ä¿® (ç›®æ¨™å­¸åˆ†å¾ RULES æŠ“)
        document.getElementById('reqTarget').innerText = target.req;
        updateCard('req', stats.req.cred, target.req, stats.req.count, reqCheckList.length);

        // 3. ç³»é¸ä¿® (è¤‡é›œè¦å‰‡)
        const eleCred = stats.deptElec.cred;
        const labCount = stats.deptElecLab.count;
        const eleTarget = target.deptElec; // 20
        const isElecPass = eleCred >= eleTarget && labCount >= 1;
        
        document.getElementById('deptElecCred').innerText = eleCred;
        const eleStat = document.getElementById('deptElecStatus');
        eleStat.className = `dash-status ${isElecPass ? 'status-ok' : 'status-ng'}`;
        eleStat.innerText = isElecPass ? "é”æ¨™" : "æœªé”æ¨™";
        
        const labText = document.getElementById('labStatusText');
        labText.innerHTML = `å¯¦é©—èª²: ${labCount} é–€ (éœ€ >= 1) ${labCount >= 1 ? 'âœ…' : 'âŒ'}`;

        // 4. é€šè­˜
        updateCard('genEd', stats.genEd.cred, target.genEd, stats.genEd.count);

        // 5. ç¸½å­¸åˆ†
        const totalStat = document.getElementById('gradStatus');
        totalStat.className = `dash-status ${stats.total >= target.total ? 'status-ok' : 'status-ng'}`;
        totalStat.innerText = stats.total >= target.total ? "é”æ¨™" : "æœªæ»¿";
        document.getElementById('totalCred').innerText = stats.total;
        document.getElementById('genElecCred').innerText = stats.genElec.cred;
    }

    function updateCard(id, current, target, count, totalCount) {
        document.getElementById(`${id}Cred`).innerText = current;
        document.getElementById(`${id}Count`).innerText = count;
        if(totalCount) document.getElementById(`${id}TotalCount`).innerText = totalCount;

        const statEl = document.getElementById(`${id}Status`);
        const isPass = current >= target;
        statEl.className = `dash-status ${isPass ? 'status-ok' : 'status-ng'}`;
        statEl.innerText = isPass ? "å·²å®Œæˆ" : "æœªå®Œæˆ";
    }

    // --- 6. æ¸²æŸ“è¡¨æ ¼ ---
    function renderTables(lists, reqCheckList) {
        const container = document.getElementById('tables-container');
        let html = "";

        html += `<h3 class="category-header">1. åŸºç¤èª²ç¨‹</h3>${renderSimpleTable(lists.basic)}`;

        html += `<h3 class="category-header">2. ç³»å¿…ä¿®ç§‘ç›®</h3>`;
        html += `<table><thead><tr><th width="40%">å¿…ä¿®ç§‘ç›®åç¨±</th><th width="15%">ç‹€æ…‹</th><th width="45%">ä¿®èª²ç´€éŒ„</th></tr></thead><tbody>`;
        reqCheckList.forEach(r => {
            const status = r.matched ? '<span class="pass">âœ” é€šé</span>' : '<span class="fail">âœ˜ æœªä¿®</span>';
            const detail = r.log ? `${r.log.name} (${r.log.gpa}, ${r.log.credit}å­¸åˆ†)` : "-";
            html += `<tr><td style="padding-left:20px; font-weight:500;">${r.name}</td><td>${status}</td><td>${detail}</td></tr>`;
        });
        html += `</tbody></table>`;

        html += `<h3 class="category-header">3. é€šè­˜èª²ç¨‹</h3>${renderSimpleTable(lists.genEd)}`;

        html += `<h3 class="category-header">4. ç³»é¸ä¿® (å«å¯¦é©—)</h3>`;
        html += `<div class="sub-category">â–¶ ç³»é¸ä¿®å¯¦é©— (å¯¦é©—/å¯¦ä½œ)</div>${renderSimpleTable(lists.deptElecLab)}`;
        html += `<br><div class="sub-category">â–¶ ç³»é¸ä¿®èª²ç¨‹</div>${renderSimpleTable(lists.deptElec)}`;

        html += `<h3 class="category-header">5. ä¸€èˆ¬é¸ä¿® (å¤–ç³»é¸ä¿®)</h3>${renderSimpleTable(lists.genElec)}`;

        if (lists.fail.length > 0) {
            html += `<h3 class="category-header" style="border-color:var(--danger-color); color:var(--danger-color);">âŒ ä¸åŠæ ¼</h3>${renderSimpleTable(lists.fail)}`;
        }

        container.innerHTML = html;
    }

    function renderSimpleTable(list) {
        if (list.length === 0) return "<p style='color:#999; margin-left:15px;'>ç„¡è³‡æ–™</p>";
        let h = `<table><thead><tr><th>ç§‘ç›®åç¨±</th><th>å­¸åˆ†</th><th>æˆç¸¾</th></tr></thead><tbody>`;
        list.forEach(c => h += `<tr><td class="course-name" style="padding-left:20px;">${c.name}</td><td>${c.credit}</td><td>${c.gpa}</td></tr>`);
        h += `</tbody></table>`;
        return h;
    }

    function reAnalyzeIfReady() { if (parsedStudentData.length > 0) analyze(); }

    // --- 7. ç®¡ç†è€…åŠŸèƒ½ ---
    function toggleAdmin() {
        if (prompt("è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼š") === "07160330") document.getElementById('admin-panel').style.display = 'block';
        else alert("å¯†ç¢¼éŒ¯èª¤");
    }

    function addException() {
        const name = document.getElementById('exName').value.trim();
        const type = document.getElementById('exType').value;
        const labels = { "Required": "ç³»å¿…ä¿®", "Basic": "åŸºç¤", "DeptElective": "ç³»é¸ä¿®", "DeptElectiveLab": "ç³»é¸ä¿®å¯¦é©—", "GeneralElective": "ä¸€èˆ¬é¸ä¿®", "GenEd": "é€šè­˜" };
        
        if (!name) return alert("è«‹è¼¸å…¥èª²å");
        const norm = normalizeName(name);
        exceptionMap[norm] = type;
        
        const list = document.getElementById('exceptionList');
        if (list.querySelector('li')?.innerText === "(ç„¡)") list.innerHTML = "";
        
        const li = document.createElement('li');
        li.innerHTML = `<strong>${name}</strong> âœ ${labels[type]} <button onclick="removeEx(this, '${norm}')" style="margin-left:10px; color:red; border:none; background:none; cursor:pointer;">[åˆªé™¤]</button>`;
        list.appendChild(li);
        document.getElementById('exName').value = "";
        reAnalyzeIfReady();
    }

    function removeEx(btn, key) {
        delete exceptionMap[key];
        btn.parentElement.remove();
        reAnalyzeIfReady();
    }
</script>

</body>
</html>
