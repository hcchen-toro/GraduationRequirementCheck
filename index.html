<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æµ·é›»æ©Ÿç•¢æ¥­å­¸åˆ†å¯©æŸ¥ç³»çµ± (by HC)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary-color: #004b97; 
            --secondary-color: #f8f9fa; 
            --success-color: #198754; 
            --danger-color: #dc3545; 
            --warning-color: #ffc107; 
            --info-color: #0dcaf0; 
        }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1280px; margin: 0 auto; background: #fff; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 12px; }
        
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 10px; border-bottom: 3px solid var(--primary-color); padding-bottom: 15px; }
        
        /* æ–°å¢ï¼šå­¸ç”Ÿå•å€™èªæ¨£å¼ */
        .student-greeting { text-align: center; font-size: 14px; color: #666; margin-bottom: 25px; height: 20px; }

        /* ç‹€æ…‹åˆ— */
        .status-bar { background: #e9ecef; padding: 10px 20px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .status-ready { color: var(--success-color); font-weight: bold; }
        .status-loading { color: #0d6efd; font-weight: bold; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; background: var(--secondary-color); padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #dee2e6; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #495057; }
        .input-group select, .input-group input[type="file"] { padding: 10px; border: 1px solid #ced4da; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        /* é–€æª»å‹¾é¸å€ */
        .checkbox-group { display: flex; gap: 20px; margin-top: 10px; background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        .checkbox-group label { margin-bottom: 0; font-weight: normal; cursor: pointer; display: flex; align-items: center; }
        .checkbox-group input { margin-right: 8px; width: 18px; height: 18px; }

        button.btn { padding: 10px 24px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        button.btn:hover { background-color: #003366; }
        button.btn-admin { background-color: #6c757d; font-size: 13px; padding: 6px 12px; }

        /* å„€è¡¨æ¿ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; cursor: pointer; }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--primary-color); }
        .dash-title { font-size: 16px; font-weight: bold; color: #555; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .dash-value { font-size: 28px; font-weight: bold; color: var(--primary-color); }
        .dash-sub { font-size: 13px; color: #777; margin-top: 5px; line-height: 1.5; }
        .dash-status { font-size: 12px; padding: 2px 8px; border-radius: 10px; color: #fff; font-weight: bold; }
        .status-ok { background-color: var(--success-color); }
        .status-ng { background-color: var(--danger-color); }
        .status-warn { background-color: var(--warning-color); color: #333; }
        .status-info { background-color: var(--info-color); color: #fff; }

        /* é€šè­˜é ˜åŸŸç‡ˆè™Ÿ */
        .ge-indicators { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .ge-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; background: #eee; color: #999; }
        .ge-tag.active { background: #d1e7dd; border-color: #badbcc; color: #0f5132; font-weight: bold; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 15px; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #dee2e6; padding: 12px 15px; text-align: left; }
        th { background-color: var(--primary-color); color: white; text-align: center; }
        td { text-align: center; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        
        .pass { color: var(--success-color); font-weight: bold; }
        .fail { color: var(--danger-color); font-weight: bold; }
        .course-name { text-align: left; font-weight: 500; }

        .category-header { margin-top: 50px; border-left: 5px solid var(--primary-color); padding-left: 15px; color: #333; font-size: 1.4em; }
        .sub-category { margin-top: 20px; color: #555; font-size: 1.1em; font-weight: bold; margin-bottom: 10px; background: #e9ecef; padding: 8px 12px; border-radius: 6px; display: inline-block; }

        /* å›åˆ°å„€è¡¨æ¿æŒ‰éˆ• */
        .back-to-top {
            text-align: right;
            margin-top: 10px;
            font-size: 14px;
            color: var(--primary-color);
            cursor: pointer;
            display: inline-block;
            width: 100%;
        }
        .back-to-top:hover { text-decoration: underline; }

        /* æ–°å¢ï¼šç¼ºæ¼é …ç›®ç¸½çµå€å¡Š */
        #missing-summary-panel {
            margin-top: 50px;
            background-color: #fff5f5;
            border: 2px solid #ffcccc;
            border-radius: 10px;
            padding: 25px;
        }
        #missing-summary-panel h3 {
            color: #d63384;
            margin-top: 0;
            border-bottom: 2px solid #ffcccc;
            padding-bottom: 10px;
        }
        .missing-item {
            color: #c0392b;
            margin-bottom: 8px;
            font-size: 15px;
            display: flex;
            align-items: flex-start;
        }
        .missing-item::before {
            content: "âš ï¸";
            margin-right: 10px;
        }
        .congrats-msg {
            color: var(--success-color);
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        /* ç®¡ç†è€…é¢æ¿ */
        #admin-panel { display: none; background: #fff3cd; padding: 20px; border: 1px solid #ffeeba; margin-top: 30px; border-radius: 8px; }
        .hidden { display: none; }

        /* åˆ—å°æ¨£å¼ */
        @media print {
            .control-panel, .status-bar, .back-to-top, .btn, #admin-panel { display: none !important; }
            .container { box-shadow: none; padding: 0; width: 100%; max-width: 100%; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .dash-card { border: 1px solid #999; break-inside: avoid; }
            h1 { font-size: 24px; margin-bottom: 10px; }
            .student-greeting { display: block !important; margin-bottom: 20px; font-weight: bold; color: #000; }
            .category-header { margin-top: 30px; page-break-after: avoid; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            #missing-summary-panel { border: 2px solid #333; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>æ±æµ·é›»æ©Ÿ ç•¢æ¥­å­¸åˆ†å¯©æŸ¥ç³»çµ±</h1>
    <div id="greetingDisplay" class="student-greeting"></div>

    <div class="status-bar">
        <span id="dbStatus" class="status-loading">â³ æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«...</span>
        <div>
            <button class="btn btn-admin" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±å‘Š</button>
            <button class="btn btn-admin" onclick="toggleAdmin()">ğŸ”§ ç®¡ç†è€…æ¨¡å¼</button>
        </div>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <label>1. é¸æ“‡å…¥å­¸å¹´åº¦</label>
            <select id="admissionYear" onchange="reAnalyzeIfReady()">
                <option value="111">111 å­¸å¹´åº¦</option>
                <option value="112">112 å­¸å¹´åº¦</option>
                <option value="113">113 å­¸å¹´åº¦</option>
                <option value="114">114 å­¸å¹´åº¦</option>
            </select>
        </div>

        <div class="input-group">
            <label>2. ä¸Šå‚³æˆç¸¾å–® & é–€æª»ç¢ºèª</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="file" id="studentFile" accept=".xlsx, .xls, .csv" />
                <button class="btn" onclick="processFileAndAnalyze()">é–‹å§‹åˆ†æ</button>
            </div>
            
            <div class="checkbox-group">
                <span style="font-weight:bold; color:#495057;">ç•¢æ¥­é–€æª»ç¢ºèªï¼š</span>
                <label><input type="checkbox" id="chkPE" onchange="reAnalyzeIfReady()"> é«”è‚²é–€æª»å·²å®Œæˆ</label>
                <label><input type="checkbox" id="chkLabor" onchange="reAnalyzeIfReady()"> å‹ä½œæ•™è‚²å·²å®Œæˆ</label>
            </div>

            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                æ”¯æ´æ ¼å¼ï¼š.xlsx, .csv (æª”åå°‡ä½œç‚ºç¨±å‘¼)ã€‚<br>
                <strong>æ›´æ–°ï¼š</strong>æœ€ä¸‹æ–¹æ–°å¢ã€Œç¼ºæ¼é …ç›®ç¸½çµã€ï¼›ä¿ç•™æ‰€æœ‰ä¿®å¾©è¦å‰‡ã€‚
            </div>
        </div>
    </div>

    <div id="result-section" class="hidden">
        
        <div id="dashboard-anchor"></div>
        <h3 style="color:#555; margin-bottom:15px;">ğŸ“Š å­¸åˆ†å¯©æ ¸å„€è¡¨æ¿</h3>
        <p style="font-size:13px; color:#777; margin-top:-10px;">(é»æ“Šä¸‹æ–¹å¡ç‰‡å¯å¿«é€Ÿè·³è½‰è‡³è©³ç´°è¡¨æ ¼)</p>

        <div class="dashboard-grid">
            <div class="dash-card" onclick="scrollToId('tbl-basic')">
                <div class="dash-title">åŸºç¤å­¸åˆ† <span id="basicStatus" class="dash-status status-ng">æœªå®Œæˆ</span></div>
                <div class="dash-value"><span id="basicCred">0</span> <span style="font-size:16px; color:#999;">/ 14</span></div>
                <div class="dash-sub" id="basicDetailText" style="font-size:12px;">
                    ä¸­æ–‡: 0/2 | è‹±æ–‡: 0/4<br>
                    è»è¨“: 0/1 | é«”è‚²: 0/4
                </div>
            </div>

            <div class="dash-card" onclick="scrollToId('tbl-req')">
                <div class="dash-title">ç³»å¿…ä¿® <span id="reqStatus" class="dash-status status-ng">æœªå®Œæˆ</span></div>
                <div class="dash-value"><span id="reqCred">0</span> <span style="font-size:16px; color:#999;">/ <span id="reqTarget">58</span></span></div>
                <div class="dash-sub">å·²ä¿®é–€æ•¸: <span id="reqCount">0</span> / <span id="reqTotalCount">0</span></div>
            </div>

            <div class="dash-card" style="border-left: 5px solid #ffc107;" onclick="scrollToId('tbl-deptElec')">
                <div class="dash-title">ç³»é¸ä¿® (å«å¯¦é©—) <span id="deptElecStatus" class="dash-status status-ng">æœªé”æ¨™</span></div>
                <div class="dash-value"><span id="deptElecCred">0</span> <span style="font-size:16px; color:#999;">/ 20</span></div>
                <div class="dash-sub" id="labStatusText">å¯¦é©—èª²: 0 é–€ (éœ€ >= 1) âŒ</div>
            </div>

            <div class="dash-card" onclick="scrollToId('tbl-genEd')">
                <div class="dash-title">é€šè­˜å­¸åˆ† <span id="genEdStatus" class="dash-status status-ng">æœªå®Œæˆ</span></div>
                <div class="dash-value"><span id="genEdCred">0</span> <span style="font-size:16px; color:#999;">/ 12</span></div>
                <div class="ge-indicators">
                    <span id="geTagHu" class="ge-tag">äººæ–‡</span>
                    <span id="geTagSo" class="ge-tag">ç¤¾æœƒ</span>
                    <span id="geTagNa" class="ge-tag">è‡ªç„¶</span>
                </div>
            </div>

            <div class="dash-card" style="background:#e3f2fd; border-color: #90caf9;">
                <div class="dash-title">å¹³å‡ç¸¾é» (GPA) <span class="dash-status status-info">åƒè€ƒ</span></div>
                <div class="dash-value" id="gpaValue">0.00</div>
                <div class="dash-sub" style="font-size:12px; color:#555;">
                    æ¡è¨ˆèª²ç¨‹æ•¸: <span id="gpaCount">0</span> é–€<br>
                    (åƒ…è¨ˆç®—æœ‰åˆ†æ•¸ä¹‹èª²ç¨‹)
                </div>
            </div>

            <div class="dash-card" style="background:#f8f9fa;" onclick="scrollToId('tbl-genElec')">
                <div class="dash-title">ç•¢æ¥­ç¸½å­¸åˆ† <span id="gradStatus" class="dash-status status-ng">æœªæ»¿</span></div>
                <div class="dash-value"><span id="totalCred">0</span> <span style="font-size:16px; color:#999;">/ 128</span></div>
                <div class="dash-sub">ä¸€èˆ¬é¸ä¿®: <span id="genElecCred">0</span> å­¸åˆ†</div>
            </div>
            
            <div class="dash-card" style="background:#f0f8ff;">
                <div class="dash-title">ç•¢æ¥­é–€æª» <span id="thresholdStatus" class="dash-status status-ng">æœªå®Œæˆ</span></div>
                <div class="dash-sub" style="font-size: 14px; margin-top: 10px;">
                    <div id="peStatusText">é«”è‚²é–€æª»ï¼šâŒ</div>
                    <div id="laborStatusText" style="margin-top:5px;">å‹ä½œæ•™è‚²ï¼šâŒ</div>
                </div>
            </div>
        </div>

        <div id="tables-container"></div>
        
        <div id="missing-summary-panel">
            <h3>ğŸ“ æº«é¦¨æé†’ï¼šç›®å‰ç¼ºå°‘é …ç›®ç¸½çµ</h3>
            <div id="missing-content"></div>
        </div>
    </div>

    <div id="admin-panel">
        <h3 style="color:#856404;">ğŸ”§ ä¾‹å¤–ç®¡ç† (ä»¥èª²ååˆ¤å®š)</h3>
        <p>è¼¸å…¥èª²ç¨‹åç¨±ï¼Œå¼·åˆ¶æŒ‡å®šå…¶é¡åˆ¥ï¼š</p>
        
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="text" id="exName" placeholder="èª²ç¨‹åç¨± (å¦‚: æ•¸ä½å½±åƒè™•ç†)" style="padding: 8px; width: 250px;">
            <select id="exType" style="padding: 8px;">
                <option value="Required">å¼·åˆ¶è¨­ç‚ºï¼šç³»å¿…ä¿®</option>
                <option value="Basic">å¼·åˆ¶è¨­ç‚ºï¼šåŸºç¤èª²ç¨‹</option>
                <option value="DeptElective">å¼·åˆ¶è¨­ç‚ºï¼šç³»é¸ä¿®</option>
                <option value="DeptElectiveLab">å¼·åˆ¶è¨­ç‚ºï¼šç³»é¸ä¿®å¯¦é©—</option>
                <option value="GeneralElective">å¼·åˆ¶è¨­ç‚ºï¼šä¸€èˆ¬é¸ä¿®</option>
                <option value="GenEd">å¼·åˆ¶è¨­ç‚ºï¼šé€šè­˜</option>
            </select>
            <button class="btn" onclick="addException()">æ–°å¢è¦å‰‡</button>
        </div>

        <div style="margin-top: 15px;">
            <strong>ç›®å‰è¦å‰‡ï¼š</strong>
            <ul id="exceptionList" style="margin-top: 5px;">
                <li style="color:#666;">(ç„¡)</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // --- 1. è¦å‰‡å®šç¾© (RULES) ---
    const CREDITS_TARGET = {
        "111": { basic: 14, req: 58, deptElec: 20, genEd: 12, total: 128 },
        "112": { basic: 14, req: 58, deptElec: 20, genEd: 12, total: 128 },
        "113": { basic: 14, req: 58, deptElec: 20, genEd: 12, total: 128 },
        "114": { basic: 14, req: 58, deptElec: 20, genEd: 12, total: 128 }
    };

    const BASE_BASIC_COURSES = [
        "ä¸­æ–‡", "å¤§ä¸€è‹±æ–‡", "å¤§äºŒè‹±æ–‡", "å¤§ä¸€é«”è‚²", "å¤§äºŒé«”è‚²", 
        "å…¨æ°‘åœ‹é˜²æ•™è‚²", "å‹ä½œæ•™è‚²", "AIæ€ç¶­èˆ‡ç¨‹å¼è¨­è¨ˆ", "ç¨‹å¼æ€ç¶­èˆ‡ç”Ÿæˆå¼AI"
    ];

    const CORE_REQUIRED_COURSES = [
        "å¾®ç©åˆ†ç”²ã€ˆä¸€ã€‰", "æ™®é€šç‰©ç†", "ç¨‹å¼è¨­è¨ˆ", "é‚è¼¯è¨­è¨ˆ", "ç·šæ€§ä»£æ•¸", 
        "é‚è¼¯è¨­è¨ˆå¯¦é©—", "å¾®ç©åˆ†ç”²ã€ˆäºŒã€‰", "ç¨‹å¼èªè¨€", 
        "å·¥ç¨‹æ•¸å­¸ï¼ˆâ… ï¼‰", "å·¥ç¨‹æ•¸å­¸ï¼ˆâ…¡ï¼‰", 
        "é›»å­å­¸ï¼ˆâ… ï¼‰", "é›»è·¯å­¸ï¼ˆâ… ï¼‰", "é›»å·¥å¯¦é©—ï¼ˆâ… ï¼‰", 
        "é›»å­å­¸ï¼ˆâ…¡ï¼‰", "é›»è·¯å­¸ï¼ˆâ…¡ï¼‰", "é›»å·¥å¯¦é©—ï¼ˆâ…¡ï¼‰", 
        "é›»ç£å­¸ï¼ˆâ… ï¼‰", "è¨Šè™Ÿèˆ‡ç³»çµ±", "é›»ç£å­¸ï¼ˆâ…¡ï¼‰", 
        "å°ˆé¡Œç ”ç©¶", "å°ˆé¡Œå¯¦ä½œ"
    ];

    const SOFT_LABS = ["å·¥ç¨‹æ•¸å­¸è»Ÿé«”å¯¦ç¿’", "é›»å­é›»è·¯è»Ÿé«”å¯¦ç¿’", "ç³»çµ±è»Ÿé«”å¯¦ç¿’"];
    const FORCE_GEN_ELEC_LIST = ["æœ‰æ©ŸåŒ–å­¸", "æ™®é€šåŒ–å­¸", "æ™®é€šç‰©ç†å¯¦é©—"];
    const DEPT_ELECTIVE_WHITELIST = ["Pythonç¨‹å¼è¨­è¨ˆ", "æ•¸ä½ç³»çµ±é››å‹è¨­è¨ˆ", "æ©Ÿå™¨å­¸ç¿’", "è³‡æ–™çµæ§‹", "å¥ˆç±³ææ–™è£½é€ èˆ‡é‡æ¸¬æŠ€è¡“", "ç”Ÿé†«å·¥ç¨‹å°è«–"];
    const DEPT_KEYWORDS = ["é›»å­", "é›»æ©Ÿ", "é›»è·¯", "è¨Šè™Ÿ", "ç³»çµ±", "åŠå°é«”", "æ™¶ç‰‡", "æ§åˆ¶", "é€šè¨Š", "é‚è¼¯", "å¾®è™•ç†", "ç¨‹å¼", "ç‰©ä»¶å°å‘", "æ¼”ç®—æ³•", "äººå·¥æ™ºæ…§", "æ·±åº¦å­¸ç¿’", "ç©é«”é›»è·¯", "å…‰é›»", "é›»ç£", "å¾®æ³¢", "å¤©ç·š"];

    const RULES = {
        "111": { basic: BASE_BASIC_COURSES, required: [...CORE_REQUIRED_COURSES, ...SOFT_LABS] },
        "112": { basic: BASE_BASIC_COURSES, required: CORE_REQUIRED_COURSES },
        "113": { basic: BASE_BASIC_COURSES, required: CORE_REQUIRED_COURSES },
        "114": { basic: BASE_BASIC_COURSES, required: CORE_REQUIRED_COURSES }
    };

    const GRADE_POINTS = { "A+": 4.3, "A": 4.0, "A-": 3.7, "B+": 3.3, "B": 3.0, "B-": 2.7, "C+": 2.3, "C": 2.0, "C-": 1.7, "D": 1.0, "E": 0, "F": 0, "X": 0 };

    let parsedStudentData = [];
    let exceptionMap = {}; 
    let courseDatabase = {}; 

    // --- 2. åˆå§‹åŒ– ---
    window.onload = async function() {
        const dbStatus = document.getElementById('dbStatus');
        const years = [111, 112, 113, 114];
        const sems = [1, 2];
        const systems = ['A', 'M']; 
        let filesToFetch = [];

        years.forEach(y => sems.forEach(s => systems.forEach(sys => filesToFetch.push(`${y}${s}${sys}-data.json`))));

        let successCount = 0;
        const requests = filesToFetch.map(fileName => 
            fetch(`./COURSE/${fileName}`).then(res => res.ok ? res.json().then(j => ({n:fileName, j})) : null).catch(()=>null)
        );

        const results = await Promise.all(requests);
        results.forEach(item => {
            if (item) {
                successCount++;
                const m = item.n.match(/^(\d{3})(\d)[A-Za-z]/);
                if (m) processJsonToDB(item.j, m[1], m[2]);
            }
        });

        if (successCount > 0) {
            dbStatus.innerText = `âœ… ç³»çµ±å°±ç·’ (å·²è¼‰å…¥ ${successCount} å€‹é–‹èª²æª”)`;
            dbStatus.className = "status-ready";
        } else {
            dbStatus.innerText = "âš ï¸ æœªåµæ¸¬åˆ°é–‹èª²æª”";
        }
    };

    function processJsonToDB(json, year, sem) {
        for (let key in json) {
            const c = json[key];
            const code = c.selection_id || c.course_code;
            if (code) courseDatabase[`${year}-${sem}-${code}`] = c;
        }
    }

    // --- 3. æª”æ¡ˆè®€å– ---
    function processFileAndAnalyze() {
        const fileInput = document.getElementById('studentFile');
        const file = fileInput.files[0];
        if (!file) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }

        // æ–°å¢ï¼šè®€å–æª”åä¸¦é¡¯ç¤ºå•å€™èª
        const fileName = file.name.split('.')[0]; // å»é™¤å‰¯æª”å
        const greetingEl = document.getElementById('greetingDisplay');
        greetingEl.innerText = `ğŸ‘‹ ${fileName} ä½ å¥½`;

        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                if (!sheetName) throw new Error("Excel/CSV æª”æ¡ˆä¸­æ‰¾ä¸åˆ°å·¥ä½œè¡¨");
                
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });
                
                parsedStudentData = normalizeData(jsonData);
                parsedStudentData = deduplicateData(parsedStudentData);
                analyze();
            } catch (err) { 
                console.error(err);
                alert("æª”æ¡ˆè®€å–å¤±æ•—: " + err.message + "\nè«‹ç¢ºèªæª”æ¡ˆæœªæå£ä¸”æ ¼å¼æ­£ç¢ºã€‚"); 
            }
        };

        reader.readAsArrayBuffer(file); 
    }

    function normalizeData(jsonData) {
        return jsonData.map(rawRow => {
            const row = {};
            for (let k in rawRow) {
                row[k.trim()] = rawRow[k];
            }
            return {
                year: String(row['å­¸å¹´åº¦'] || row['year'] || "").trim(),
                sem: String(row['å­¸æœŸ'] || row['semester'] || "").trim(),
                code: String(row['é¸èª²ä»£è™Ÿ'] || row['code'] || "").trim(),
                name: String(row['ç§‘ç›®åç¨±'] || row['name'] || "").trim(),
                credit: parseFloat(row['å­¸åˆ†'] || row['credits'] || 0),
                gpa: String(row['GPA'] || row['gpa'] || "").trim()
            };
        }).filter(item => item.name);
    }

    // --- 3.1 å»é‡è¤‡é‚è¼¯ ---
    function deduplicateData(data) {
        const map = new Map();
        data.forEach(item => {
            const normName = normalizeName(item.name);
            const key = normName + "_" + item.sem; 
            const itemPoint = getGradePoint(item.gpa);
            if (map.has(key)) {
                const exist = map.get(key);
                const existPoint = getGradePoint(exist.gpa);
                if (itemPoint > existPoint) { map.set(key, item); }
                else if (itemPoint === existPoint) {
                    if (parseInt(item.year) > parseInt(exist.year)) map.set(key, item);
                }
            } else { map.set(key, item); }
        });
        return Array.from(map.values()).sort((a,b) => (parseInt(a.year)*10+(a.sem==='ä¸Š'?1:2)) - (parseInt(b.year)*10+(b.sem==='ä¸Š'?1:2)));
    }

    function getGradePoint(grade) { return GRADE_POINTS[grade] !== undefined ? GRADE_POINTS[grade] : -1; }

    // --- 4. æ ¸å¿ƒé‚è¼¯ ---
    function normalizeName(name) {
        if (!name) return "";
        return name.trim().replace(/\s+/g, "").replace(/ï¼ˆ/g, "(").replace(/ï¼‰/g, ")").replace(/ã€ˆ/g, "(").replace(/ã€‰/g, ")").replace(/â… /g, "I").replace(/â…¡/g, "II");
    }

    function isSameName(sName, rName) { return normalizeName(sName) === normalizeName(rName); }
    function isBasicCourse(name, list) { return list.some(b => normalizeName(name).includes(normalizeName(b))); }
    function isGeneralEd(name) {
        const p = ["äººæ–‡", "ç¤¾æœƒ", "è‡ªç„¶", "æ°¸çºŒ", "æ–‡æ˜", "é ˜å°", "è­°é¡Œ"];
        return p.some(pre => name.startsWith(pre + "ï¼š") || name.startsWith(pre + ":") || name.includes(pre + "é ˜åŸŸ") || name.startsWith(pre));
    }
    function isForceGenElective(name) { return FORCE_GEN_ELEC_LIST.some(f => normalizeName(name).includes(normalizeName(f))); }
    function isDeptElective(name, credit) {
        const n = normalizeName(name);
        if (DEPT_ELECTIVE_WHITELIST.some(w => n.includes(normalizeName(w)))) return true;
        return (credit >= 3 && DEPT_KEYWORDS.some(k => n.includes(k)));
    }

    function analyze() {
        if (parsedStudentData.length === 0) return alert("è®€å–åˆ°çš„è³‡æ–™ç‚ºç©ºã€‚");

        const year = document.getElementById('admissionYear').value;
        const rule = RULES[year];
        const target = CREDITS_TARGET[year];
        
        let stats = {
            basic: { cred: 0, count: 0, details: { chi:0, eng:0, mil:0, pe:0 } },
            req: { cred: 0, count: 0 },
            deptElec: { cred: 0, count: 0 },
            deptElecLab: { cred: 0, count: 0 },
            genElec: { cred: 0, count: 0 },
            genEd: { cred: 0, count: 0, domains: { hu: false, so: false, na: false } },
            total: 0
        };

        let lists = { basic: [], req: [], deptElec: [], deptElecLab: [], genElec: [], genEd: [], fail: [] };
        let reqCheckList = rule.required.map(r => ({ name: r, matched: false, log: null }));
        
        let totalPoints = 0, totalGpaCredits = 0;

        parsedStudentData.forEach(rec => {
            const passGrades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'æŠµå…', 'é€šé'];
            const pts = getGradePoint(rec.gpa);
            if (pts >= 0) { totalPoints += pts * rec.credit; totalGpaCredits += rec.credit; }

            if (!passGrades.includes(rec.gpa)) { lists.fail.push(rec); return; }

            let cat = "Unknown";
            const normName = normalizeName(rec.name);

            if (exceptionMap[normName]) {
                cat = exceptionMap[normName];
                if (cat === 'Required') {
                    for (let r of reqCheckList) { if (!r.matched && isSameName(rec.name, r.name)) { r.matched = true; r.log = rec; break; } }
                }
            } 
            else {
                if (isBasicCourse(rec.name, rule.basic)) cat = "Basic";
                else {
                    let matched = false;
                    for (let r of reqCheckList) {
                        if (!r.matched && isSameName(rec.name, r.name)) {
                            cat = "Required"; r.matched = true; r.log = rec; matched = true; break;
                        }
                    }
                    if (!matched) {
                        if (isGeneralEd(rec.name)) cat = "GenEd";
                        else if (isForceGenElective(rec.name)) cat = "GeneralElective";
                        else {
                            const isLabKey = rec.name.includes("å¯¦é©—") || rec.name.includes("å¯¦ä½œ");
                            const exclude = rec.name.includes("å·¥ç¨‹æ•¸å­¸") || rec.name.includes("é›»è·¯å­¸") || rec.name.includes("é›»å­å­¸") || rec.name.includes("å¯¦å‹™æ¢ç´¢");
                            if (rec.credit === 1 && isLabKey && !exclude) cat = "DeptElectiveLab";
                            else if (isDeptElective(rec.name, rec.credit)) cat = "DeptElective";
                            else cat = "GeneralElective";
                        }
                    }
                }
            }

            stats.total += rec.credit;
            if (cat === "Basic") { 
                lists.basic.push(rec); stats.basic.cred += rec.credit; stats.basic.count++;
                if (rec.name.includes("ä¸­æ–‡")) stats.basic.details.chi++;
                else if (rec.name.includes("è‹±æ–‡")) stats.basic.details.eng++;
                else if (rec.name.includes("è»è¨“") || rec.name.includes("å…¨æ°‘åœ‹é˜²")) stats.basic.details.mil++;
                else if (rec.name.includes("é«”è‚²")) stats.basic.details.pe++;
            }
            else if (cat === "Required") { lists.req.push(rec); stats.req.cred += rec.credit; stats.req.count++; }
            else if (cat === "DeptElective") { lists.deptElec.push(rec); stats.deptElec.cred += rec.credit; stats.deptElec.count++; }
            else if (cat === "DeptElectiveLab") { lists.deptElecLab.push(rec); stats.deptElec.cred += rec.credit; stats.deptElecLab.count++; } 
            else if (cat === "GenEd") { 
                lists.genEd.push(rec); stats.genEd.cred += rec.credit; stats.genEd.count++; 
                if (rec.name.includes("äººæ–‡")) stats.genEd.domains.hu = true;
                if (rec.name.includes("ç¤¾æœƒ")) stats.genEd.domains.so = true;
                if (rec.name.includes("è‡ªç„¶")) stats.genEd.domains.na = true;
            }
            else if (cat === "GeneralElective") { lists.genElec.push(rec); stats.genElec.cred += rec.credit; stats.genElec.count++; }
        });

        const finalGpa = totalGpaCredits > 0 ? (totalPoints / totalGpaCredits).toFixed(2) : "0.00";
        updateDashboard(stats, target, reqCheckList, finalGpa, totalGpaCredits);
        renderTables(lists, reqCheckList);
        
        // æ–°å¢ï¼šç”¢ç”Ÿç¸½çµ
        renderMissingSummary(stats, target, reqCheckList);
    }

    // --- 5. æ›´æ–°å„€è¡¨æ¿ ---
    function updateDashboard(stats, target, reqCheckList, gpa, gpaCount) {
        document.getElementById('result-section').classList.remove('hidden');

        updateCard('basic', stats.basic.cred, target.basic, stats.basic.count);
        const d = stats.basic.details;
        document.getElementById('basicDetailText').innerHTML = `ä¸­æ–‡:${d.chi}/2 ${d.chi>=2?'âœ”':'âŒ'} | è‹±æ–‡:${d.eng}/4 ${d.eng>=4?'âœ”':'âŒ'}<br>è»è¨“:${d.mil}/1 ${d.mil>=1?'âœ”':'âŒ'} | é«”è‚²:${d.pe}/4 ${d.pe>=4?'âœ”':'âŒ'}`;
        const isBasicAllPass = (d.chi>=2 && d.eng>=4 && d.mil>=1 && d.pe>=4);
        document.getElementById('basicStatus').className = `dash-status ${isBasicAllPass?'status-ok':'status-ng'}`;
        document.getElementById('basicStatus').innerText = isBasicAllPass ? "å·²å®Œæˆ" : "æœªå®Œæˆ";

        document.getElementById('reqTarget').innerText = target.req;
        updateCard('req', stats.req.cred, target.req, stats.req.count, reqCheckList.length);

        const isElecPass = stats.deptElec.cred >= target.deptElec && stats.deptElecLab.count >= 1;
        document.getElementById('deptElecCred').innerText = stats.deptElec.cred;
        document.getElementById('deptElecStatus').className = `dash-status ${isElecPass?'status-ok':'status-ng'}`;
        document.getElementById('deptElecStatus').innerText = isElecPass ? "é”æ¨™" : "æœªé”æ¨™";
        document.getElementById('labStatusText').innerHTML = `å¯¦é©—èª²: ${stats.deptElecLab.count} é–€ (éœ€ >= 1) ${stats.deptElecLab.count>=1?'âœ…':'âŒ'}`;

        updateCard('genEd', stats.genEd.cred, target.genEd, stats.genEd.count);
        const gd = stats.genEd.domains;
        document.getElementById('geTagHu').className = `ge-tag ${gd.hu ? 'active' : ''}`;
        document.getElementById('geTagSo').className = `ge-tag ${gd.so ? 'active' : ''}`;
        document.getElementById('geTagNa').className = `ge-tag ${gd.na ? 'active' : ''}`;

        document.getElementById('gpaValue').innerText = gpa;
        document.getElementById('gpaCount').innerText = gpaCount;

        const peOk = document.getElementById('chkPE').checked;
        const laborOk = document.getElementById('chkLabor').checked;
        document.getElementById('peStatusText').innerHTML = `é«”è‚²é–€æª»ï¼š${peOk ? 'âœ… é€šé' : 'âŒ æœªé€šé'}`;
        document.getElementById('laborStatusText').innerHTML = `å‹ä½œæ•™è‚²ï¼š${laborOk ? 'âœ… é€šé' : 'âŒ æœªé€šé'}`;
        
        const isTotalOk = stats.total >= target.total;
        document.getElementById('gradStatus').className = `dash-status ${isTotalOk?'status-ok':'status-ng'}`;
        document.getElementById('gradStatus').innerText = isTotalOk ? "é”æ¨™" : "æœªæ»¿";
        document.getElementById('totalCred').innerText = stats.total;
        document.getElementById('genElecCred').innerText = stats.genElec.cred;
    }

    // --- æ–°å¢ï¼šç¸½çµé‚è¼¯ ---
    function renderMissingSummary(stats, target, reqCheckList) {
        const container = document.getElementById('missing-content');
        const peOk = document.getElementById('chkPE').checked;
        const laborOk = document.getElementById('chkLabor').checked;
        let msgs = [];

        // åŸºç¤
        const d = stats.basic.details;
        if (d.chi < 2) msgs.push(`åŸºç¤: ä¸­æ–‡å°šç¼º ${2 - d.chi} é–€`);
        if (d.eng < 4) msgs.push(`åŸºç¤: è‹±æ–‡å°šç¼º ${4 - d.eng} é–€`);
        if (d.mil < 1) msgs.push(`åŸºç¤: è»è¨“/åœ‹é˜²å°šç¼º 1 é–€`);
        if (d.pe < 4) msgs.push(`åŸºç¤: é«”è‚²å°šç¼º ${4 - d.pe} é–€`);

        // å¿…ä¿®
        if (stats.req.cred < target.req) msgs.push(`ç³»å¿…ä¿®: å­¸åˆ†ä¸è¶³ (ç›®å‰ ${stats.req.cred}/${target.req})`);
        reqCheckList.forEach(r => {
            if (!r.matched) msgs.push(`å¿…ä¿®ç¼ºèª²: ${r.name}`);
        });

        // ç³»é¸ä¿®
        if (stats.deptElec.cred < target.deptElec) msgs.push(`ç³»é¸ä¿®: å­¸åˆ†ä¸è¶³ï¼Œå°šç¼º ${target.deptElec - stats.deptElec.cred} å­¸åˆ†`);
        if (stats.deptElecLab.count < 1) msgs.push(`ç³»é¸ä¿®: ç¼ºå°‘å¯¦é©—èª²ç¨‹ (éœ€è‡³å°‘ 1 é–€)`);

        // é€šè­˜
        if (stats.genEd.cred < target.genEd) msgs.push(`é€šè­˜: å­¸åˆ†ä¸è¶³ï¼Œå°šç¼º ${target.genEd - stats.genEd.cred} å­¸åˆ†`);
        if (!stats.genEd.domains.hu) msgs.push(`é€šè­˜: ç¼ºå°‘ [äººæ–‡] é ˜åŸŸèª²ç¨‹`);
        if (!stats.genEd.domains.so) msgs.push(`é€šè­˜: ç¼ºå°‘ [ç¤¾æœƒ] é ˜åŸŸèª²ç¨‹`);
        if (!stats.genEd.domains.na) msgs.push(`é€šè­˜: ç¼ºå°‘ [è‡ªç„¶] é ˜åŸŸèª²ç¨‹`);

        // é–€æª»
        if (!peOk) msgs.push(`ç•¢æ¥­é–€æª»: é«”è‚²é–€æª»æœªå‹¾é¸`);
        if (!laborOk) msgs.push(`ç•¢æ¥­é–€æª»: å‹ä½œæ•™è‚²æœªå‹¾é¸`);

        // ç¸½å­¸åˆ†
        if (stats.total < target.total) msgs.push(`ç•¢æ¥­ç¸½å­¸åˆ†: ä¸è¶³ï¼Œå°šå·® ${target.total - stats.total} å­¸åˆ†`);

        if (msgs.length === 0) {
            container.innerHTML = `<div class="congrats-msg">ğŸ‰ æ­å–œï¼ç›®å‰ç³»çµ±æª¢æŸ¥æ‰€æœ‰é …ç›®çš†å·²é”æ¨™ï¼</div>`;
        } else {
            let html = "";
            msgs.forEach(m => html += `<div class="missing-item">${m}</div>`);
            container.innerHTML = html;
        }
    }

    function updateCard(id, current, target, count, totalCount) {
        const credEl = document.getElementById(`${id}Cred`); if(credEl) credEl.innerText = current;
        const countEl = document.getElementById(`${id}Count`); if(countEl) countEl.innerText = count;
        const totalEl = document.getElementById(`${id}TotalCount`); if(totalEl) totalEl.innerText = totalCount;
        const statEl = document.getElementById(`${id}Status`);
        if (statEl && id !== 'basic' && id !== 'genEd') {
            statEl.className = `dash-status ${current >= target ? 'status-ok' : 'status-ng'}`;
            statEl.innerText = current >= target ? "å·²å®Œæˆ" : "æœªå®Œæˆ";
        }
    }

    function scrollToId(id) { document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }

    function renderTables(lists, reqCheckList) {
        const container = document.getElementById('tables-container');
        const backLink = `<div class="back-to-top" onclick="scrollToId('dashboard-anchor')">â†‘ å›åˆ°å„€è¡¨æ¿</div>`;
        let html = "";

        html += `<h3 id="tbl-basic" class="category-header">1. åŸºç¤èª²ç¨‹</h3>` + renderSimpleTable(lists.basic) + backLink;

        html += `<h3 id="tbl-req" class="category-header">2. å­¸ç³»å¿…ä¿®ç§‘ç›®</h3>`;
        html += `<table><thead><tr><th width="35%">å¿…ä¿®ç§‘ç›®åç¨±</th><th width="10%">å­¸åˆ†</th><th width="15%">ç‹€æ…‹</th><th width="40%">ä¿®èª²ç´€éŒ„</th></tr></thead><tbody>`;
        reqCheckList.forEach(r => {
            const status = r.matched ? '<span class="pass">âœ” é€šé</span>' : '<span class="fail">âœ˜ æœªä¿®</span>';
            const credit = r.matched && r.log ? r.log.credit : 0;
            const detail = r.log ? `${r.log.name} (${r.log.gpa})` : "-";
            html += `<tr><td style="padding-left:20px; font-weight:500;">${r.name}</td><td>${credit}</td><td>${status}</td><td>${detail}</td></tr>`;
        });
        html += `</tbody></table>` + backLink;

        html += `<h3 id="tbl-genEd" class="category-header">3. é€šè­˜èª²ç¨‹</h3>` + renderSimpleTable(lists.genEd) + backLink;
        html += `<h3 id="tbl-deptElec" class="category-header">4. ç³»é¸ä¿® (å«å¯¦é©—)</h3><div class="sub-category">â–¶ ç³»é¸ä¿®å¯¦é©— (å¯¦é©—/å¯¦ä½œ)</div>${renderSimpleTable(lists.deptElecLab)}<br><div class="sub-category">â–¶ ç³»é¸ä¿®èª²ç¨‹</div>${renderSimpleTable(lists.deptElec)}` + backLink;
        html += `<h3 id="tbl-genElec" class="category-header">5. ä¸€èˆ¬é¸ä¿® (å¤–ç³»é¸ä¿®)</h3>` + renderSimpleTable(lists.genElec) + backLink;

        if (lists.fail.length > 0) html += `<h3 class="category-header" style="border-color:var(--danger-color); color:var(--danger-color);">âŒ ä¸åŠæ ¼ / æœªé€šé</h3>${renderSimpleTable(lists.fail)}` + backLink;

        container.innerHTML = html;
    }

    function renderSimpleTable(list) {
        if (list.length === 0) return "<p style='color:#999; margin-left:15px;'>ç„¡è³‡æ–™</p>";
        list.sort((a,b) => (a.year - b.year) || (a.sem - b.sem));
        let h = `<table><thead><tr><th width="15%">å­¸æœŸ</th><th width="55%">ç§‘ç›®åç¨±</th><th width="15%">å­¸åˆ†</th><th width="15%">æˆç¸¾</th></tr></thead><tbody>`;
        list.forEach(c => h += `<tr><td>${c.year}-${c.sem}</td><td class="course-name" style="padding-left:20px;">${c.name}</td><td>${c.credit}</td><td>${c.gpa}</td></tr>`);
        h += `</tbody></table>`;
        return h;
    }

    function reAnalyzeIfReady() { if (parsedStudentData.length > 0) analyze(); }
    function toggleAdmin() { if (prompt("è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼š") === "07160330") document.getElementById('admin-panel').style.display = 'block'; else alert("å¯†ç¢¼éŒ¯èª¤"); }
    function addException() {
        const name = document.getElementById('exName').value.trim();
        const type = document.getElementById('exType').value;
        const labels = { "Required": "ç³»å¿…ä¿®", "Basic": "åŸºç¤", "DeptElective": "ç³»é¸ä¿®", "DeptElectiveLab": "ç³»é¸ä¿®å¯¦é©—", "GeneralElective": "ä¸€èˆ¬é¸ä¿®", "GenEd": "é€šè­˜" };
        if (!name) return alert("è«‹è¼¸å…¥èª²å");
        const norm = normalizeName(name);
        exceptionMap[norm] = type;
        const list = document.getElementById('exceptionList');
        if (list.querySelector('li')?.innerText === "(ç„¡)") list.innerHTML = "";
        const li = document.createElement('li');
        li.innerHTML = `<strong>${name}</strong> âœ ${labels[type]} <button onclick="removeEx(this, '${norm}')" style="margin-left:10px; color:red; border:none; background:none; cursor:pointer;">[åˆªé™¤]</button>`;
        list.appendChild(li);
        document.getElementById('exName').value = "";
        reAnalyzeIfReady();
    }
    function removeEx(btn, key) { delete exceptionMap[key]; btn.parentElement.remove(); reAnalyzeIfReady(); }
</script>

</body>
</html>
