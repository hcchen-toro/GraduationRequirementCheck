<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æµ·é›»æ©Ÿç•¢æ¥­å­¸åˆ†å¯©æŸ¥ç³»çµ± (ExcelåŠ å¼·ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #004b97; --secondary-color: #e9ecef; --accent-color: #d63384; }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 12px; }
        
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; }
        
        .status-bar { background: #e2e3e5; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .status-ready { color: #198754; font-weight: bold; }
        .status-loading { color: #0d6efd; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }

        .control-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: var(--secondary-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        
        button.btn { padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button.btn:hover { background-color: #003366; }
        button.btn-admin { background-color: #6c757d; font-size: 12px; padding: 5px 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: center; }
        th { background-color: var(--primary-color); color: white; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        
        .pass { color: #198754; font-weight: bold; }
        .fail { color: #dc3545; font-weight: bold; }
        
        .summary-box { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { flex: 1; min-width: 150px; background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #bbdefb; }
        .stat-val { font-size: 24px; font-weight: bold; color: var(--primary-color); }

        /* ç®¡ç†è€…é¢æ¿ */
        #admin-panel { display: none; background: #fff3cd; padding: 20px; border: 1px solid #ffeeba; margin-top: 30px; border-radius: 8px; position: relative; }
        .admin-badge { position: absolute; top: -10px; right: 10px; background: #ffc107; padding: 2px 8px; font-size: 12px; border-radius: 4px; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>æ±æµ·é›»æ©Ÿ ç•¢æ¥­å­¸åˆ†å¯©æŸ¥ç³»çµ± <span style="font-size:0.6em; color:#666;">(v3.0)</span></h1>

    <div class="status-bar">
        <span id="dbStatus">æ­£åœ¨åˆå§‹åŒ–...</span>
        <button class="btn btn-admin" onclick="toggleAdmin()">ğŸ”§ ç®¡ç†è€…æ¨¡å¼</button>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <label>1. é¸æ“‡å…¥å­¸å¹´åº¦ (å¿…ä¿®è¦å‰‡)</label>
            <select id="admissionYear" class="form-control" style="padding: 8px; width: 100%;" onchange="reAnalyzeIfReady()">
                <option value="111">111 å­¸å¹´åº¦</option>
                <option value="112">112 å­¸å¹´åº¦</option>
                <option value="113">113 å­¸å¹´åº¦</option>
                <option value="114">114 å­¸å¹´åº¦</option>
            </select>
        </div>

        <div class="input-group">
            <label>2. ä¸Šå‚³æˆç¸¾å–® (.xlsx / .csv)</label>
            <input type="file" id="studentFile" accept=".xlsx, .xls, .csv" />
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                æ”¯æ´ Excel æª”ã€‚æ¬„ä½éœ€åŒ…å«ï¼šå­¸å¹´åº¦, å­¸æœŸ, é¸èª²ä»£è™Ÿ, ç§‘ç›®åç¨±, å­¸åˆ†, GPA
            </div>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="processFileAndAnalyze()">é–‹å§‹åˆ†æ</button>
            </div>
        </div>
    </div>

    <div id="result-section" class="hidden">
        <div class="summary-box">
            <div class="stat-card">
                <div>å¿…ä¿®å®Œæˆç‡</div>
                <div class="stat-val" id="reqRate">0%</div>
            </div>
            <div class="stat-card">
                <div>ç³»å¿…ä¿®å­¸åˆ†</div>
                <div class="stat-val" id="reqCredits">0</div>
            </div>
            <div class="stat-card">
                <div>ç³»é¸ä¿®å­¸åˆ†</div>
                <div class="stat-val" id="elecCredits">0</div>
            </div>
            <div class="stat-card">
                <div>é€šè­˜/å…¶ä»–å­¸åˆ†</div>
                <div class="stat-val" id="genCredits">0</div>
            </div>
            <div class="stat-card">
                <div>ç¸½å–å¾—å­¸åˆ†</div>
                <div class="stat-val" id="totalCredits">0</div>
            </div>
        </div>
        <div id="tables-container"></div>
    </div>

    <div id="admin-panel">
        <div class="admin-badge">Admin Mode</div>
        <h3>ä¾‹å¤–ç®¡ç†æ§åˆ¶å°</h3>
        <p>åœ¨æ­¤è¨­å®šç‰¹æ®Šèª²ç¨‹çš„æ­¸å±¬ï¼Œè¨­å®šå¾Œæœƒå³æ™‚æ›´æ–°åˆ†æçµæœã€‚</p>
        
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="text" id="exCode" placeholder="é¸èª²ä»£è™Ÿ (å¦‚ 1091)" style="padding: 8px; width: 150px;">
            <select id="exType" style="padding: 8px;">
                <option value="Required">å¼·åˆ¶è¨­ç‚ºï¼šç³»å¿…ä¿®</option>
                <option value="Elective">å¼·åˆ¶è¨­ç‚ºï¼šç³»é¸ä¿®</option>
                <option value="General">å¼·åˆ¶è¨­ç‚ºï¼šé€šè­˜/å…¶ä»–</option>
            </select>
            <button class="btn" style="padding: 8px 15px; font-size: 14px;" onclick="addException()">æ–°å¢è¦å‰‡</button>
        </div>

        <div style="margin-top: 15px; border-top: 1px solid #dee2e6; padding-top: 10px;">
            <strong>ç›®å‰çš„ä¾‹å¤–è¦å‰‡ï¼š</strong>
            <ul id="exceptionList" style="list-style: none; padding: 0; margin-top: 5px;">
                <li style="color:#666;">(å°šç„¡è¦å‰‡)</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™èˆ‡å…¨åŸŸè®Šæ•¸ ---
    
    // å¿…ä¿®è¦å‰‡ (111~114) - ä¿æŒä¸è®Š
    const RULES = {
        "111": {
            subjects: [
                { name: "å¾®ç©åˆ†ç”²ã€ˆä¸€ã€‰", codes: ["24383", "1100"], credits: 3 },
                { name: "æ™®é€šç‰©ç†", codes: ["21004", "1091"], credits: 3 },
                { name: "ç¨‹å¼è¨­è¨ˆ", codes: ["28111", "1093"], credits: 3 },
                { name: "é‚è¼¯è¨­è¨ˆ", codes: ["28071", "1095"], credits: 3 },
                { name: "ç·šæ€§ä»£æ•¸", codes: ["21020", "1098"], credits: 3 },
                { name: "é‚è¼¯è¨­è¨ˆå¯¦é©—", codes: ["36001", "1096"], credits: 1 },
                { name: "å¾®ç©åˆ†ç”²ã€ˆäºŒã€‰", codes: ["24385", "1098"], credits: 3 },
                { name: "ç¨‹å¼èªè¨€", codes: ["28027", "1094"], credits: 3 },
                { name: "å·¥ç¨‹æ•¸å­¸ï¼ˆâ… ï¼‰", codes: ["36033", "1091"], credits: 3 },
                { name: "å·¥ç¨‹æ•¸å­¸ï¼ˆâ…¡ï¼‰", codes: ["36034", "1102"], credits: 3 },
                { name: "é›»å­å­¸ï¼ˆâ… ï¼‰", codes: ["36029", "1127"], credits: 3 },
                { name: "é›»è·¯å­¸ï¼ˆâ… ï¼‰", codes: ["36162", "1103"], credits: 3 },
                { name: "é›»å·¥å¯¦é©—ï¼ˆâ… ï¼‰", codes: ["36031", "1100"], credits: 1 },
                { name: "é›»å·¥å¯¦é©—ï¼ˆâ…¡ï¼‰", codes: ["36032", "1100"], credits: 1 },
                { name: "é›»ç£å­¸ï¼ˆâ… ï¼‰", codes: ["36035", "1103"], credits: 3 },
                { name: "é›»è·¯å­¸ï¼ˆâ…¡ï¼‰", codes: ["36163", "1102"], credits: 3 },
                { name: "é›»å­å­¸ï¼ˆâ…¡ï¼‰", codes: ["36030", "1098"], credits: 3 },
                { name: "è¨Šè™Ÿèˆ‡ç³»çµ±", codes: ["36013", "1104"], credits: 3 },
                { name: "é›»ç£å­¸ï¼ˆâ…¡ï¼‰", codes: ["36036"], credits: 3 },
                { name: "å°ˆé¡Œç ”ç©¶", codes: ["22107"], credits: 2 },
                { name: "å°ˆé¡Œå¯¦ä½œ", codes: ["28350"], credits: 2 },
                { name: "å·¥ç¨‹æ•¸å­¸è»Ÿé«”å¯¦ç¿’", codes: ["36147", "1097"], credits: 1 }, 
                { name: "é›»å­é›»è·¯è»Ÿé«”å¯¦ç¿’", codes: ["36146"], credits: 1 },
                { name: "ç³»çµ±è»Ÿé«”å¯¦ç¿’", codes: ["36148"], credits: 1 }
            ]
        },
        "112": { subjects: [] },
        "113": {
            subjects: [
                { name: "å¾®ç©åˆ†ç”²ã€ˆä¸€ã€‰", codes: ["24383", "1100"], credits: 3 },
                { name: "æ™®é€šç‰©ç†", codes: ["21004", "1091"], credits: 3 },
                { name: "ç¨‹å¼è¨­è¨ˆ", codes: ["28111", "1093"], credits: 3 },
                { name: "é‚è¼¯è¨­è¨ˆ", codes: ["28071", "1095"], credits: 3 },
                { name: "ç·šæ€§ä»£æ•¸", codes: ["21020", "1098"], credits: 3 },
                { name: "é‚è¼¯è¨­è¨ˆå¯¦é©—", codes: ["36001", "1096"], credits: 1 },
                { name: "å¾®ç©åˆ†ç”²ã€ˆäºŒã€‰", codes: ["24385", "1098"], credits: 3 },
                { name: "ç¨‹å¼èªè¨€", codes: ["28027", "1094"], credits: 3 },
                { name: "å·¥ç¨‹æ•¸å­¸ï¼ˆâ… ï¼‰", codes: ["36033", "1091"], credits: 3 },
                { name: "å·¥ç¨‹æ•¸å­¸ï¼ˆâ…¡ï¼‰", codes: ["36034", "1102"], credits: 3 },
                { name: "é›»å­å­¸ï¼ˆâ… ï¼‰", codes: ["36029", "1127"], credits: 3 },
                { name: "é›»è·¯å­¸ï¼ˆâ… ï¼‰", codes: ["36162", "1103"], credits: 3 },
                { name: "é›»å·¥å¯¦é©—ï¼ˆâ… ï¼‰", codes: ["36031", "1100"], credits: 1 },
                { name: "é›»å·¥å¯¦é©—ï¼ˆâ…¡ï¼‰", codes: ["36032", "1100"], credits: 1 },
                { name: "é›»ç£å­¸ï¼ˆâ… ï¼‰", codes: ["36035", "1103"], credits: 3 },
                { name: "é›»è·¯å­¸ï¼ˆâ…¡ï¼‰", codes: ["36163", "1102"], credits: 3 },
                { name: "é›»å­å­¸ï¼ˆâ…¡ï¼‰", codes: ["36030", "1098"], credits: 3 },
                { name: "è¨Šè™Ÿèˆ‡ç³»çµ±", codes: ["36013", "1104"], credits: 3 },
                { name: "é›»ç£å­¸ï¼ˆâ…¡ï¼‰", codes: ["36036"], credits: 3 },
                { name: "å°ˆé¡Œç ”ç©¶", codes: ["22107"], credits: 2 },
                { name: "å°ˆé¡Œå¯¦ä½œ", codes: ["28350"], credits: 2 }
            ]
        },
        "114": { subjects: [] }
    };
    // è¤‡è£½è¦å‰‡
    RULES["112"].subjects = JSON.parse(JSON.stringify(RULES["111"].subjects));
    RULES["114"].subjects = JSON.parse(JSON.stringify(RULES["113"].subjects));

    let courseDatabase = {}; // Key: "Year-Sem-Code"
    let parsedStudentData = []; // æš«å­˜å·²è§£æçš„å­¸ç”Ÿè³‡æ–™
    let exceptionMap = {}; // ç®¡ç†è€…ä¾‹å¤–
    let isDbLoaded = false;

    // --- 2. è‡ªå‹•è¼‰å…¥é–‹èª²è³‡æ–™ (å–ä»£æ‰‹å‹•ä¸Šå‚³) ---
    window.onload = async function() {
        const dbStatus = document.getElementById('dbStatus');
        dbStatus.innerText = "â³ æ­£åœ¨å¾ ./COURSE/ è³‡æ–™å¤¾è®€å–é–‹èª²è³‡æ–™...";
        dbStatus.className = "status-loading";

        // ç”¢ç”Ÿå¯èƒ½çš„æª”åæ¸…å–® (111~114, 1/2, A/M)
        const years = [111, 112, 113, 114];
        const sems = [1, 2];
        const systems = ['A', 'M']; // A:æ—¥é–“, M:ç ”ç©¶æ‰€
        let filesToFetch = [];

        years.forEach(y => {
            sems.forEach(s => {
                systems.forEach(sys => {
                    filesToFetch.push(`${y}${s}${sys}-data.json`);
                });
            });
        });

        let successCount = 0;
        
        // ä¸¦è¡Œä¸‹è¼‰
        const requests = filesToFetch.map(fileName => 
            fetch(`./COURSE/${fileName}`)
                .then(res => {
                    if(!res.ok) throw new Error("404");
                    return res.json().then(json => ({ fileName, json }));
                })
                .catch(err => null) // å¤±æ•—å›å‚³ null
        );

        const results = await Promise.all(requests);
        
        results.forEach(item => {
            if (item) {
                successCount++;
                // è§£ææª”åå–å¾— Year, Sem
                const match = item.fileName.match(/^(\d{3})(\d)[A-Za-z]/);
                if (match) {
                    processJsonToDB(item.json, match[1], match[2]);
                }
            }
        });

        if (successCount > 0) {
            isDbLoaded = true;
            dbStatus.innerText = `âœ… ç³»çµ±å°±ç·’ (å·²è¼‰å…¥ ${successCount} å€‹é–‹èª²æª”æ¡ˆ)`;
            dbStatus.className = "status-ready";
        } else {
            dbStatus.innerText = "âš ï¸ ç„¡æ³•è¼‰å…¥é–‹èª²è³‡æ–™ (è«‹ç¢ºèª COURSE è³‡æ–™å¤¾æ˜¯å¦å­˜åœ¨æ–¼ Server)";
            dbStatus.className = "status-error";
        }
    };

    function processJsonToDB(json, year, sem) {
        // å°‡ JSON è³‡æ–™è½‰å…¥ courseDatabase ç´¢å¼•
        for (let key in json) {
            const c = json[key];
            const code = c.selection_id || c.course_code;
            if (code) {
                const dbKey = `${year}-${sem}-${code}`;
                courseDatabase[dbKey] = c;
            }
        }
    }

    // --- 3. æª”æ¡ˆè™•ç† (Excel & CSV) ---
    function processFileAndAnalyze() {
        const fileInput = document.getElementById('studentFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = e.target.result;
            
            // åˆ¤æ–·æ˜¯å¦ç‚º Excel
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                try {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    // è½‰ç‚º JSONï¼Œç¬¬ä¸€åˆ—ç‚º Header
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    parsedStudentData = normalizeData(jsonData);
                    analyze();
                } catch (err) {
                    console.error(err);
                    alert("Excel è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ä¸è¢«ä¿è­·ã€‚");
                }
            } else {
                // CSV è™•ç†
                parsedStudentData = parseCSV(data);
                analyze();
            }
        };

        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            reader.readAsBinaryString(file);
        } else {
            reader.readAsText(file); // CSV ç”¨ Text è®€å–
        }
    }

    // å°‡ Excel JSON è½‰ç‚ºçµ±ä¸€æ ¼å¼
    function normalizeData(jsonData) {
        // å°‹æ‰¾å°æ‡‰çš„ key (å®¹è¨±ä½¿ç”¨è€…è¡¨é ­æœ‰äº›å¾®å·®ç•°)
        return jsonData.map(row => {
            // å˜—è©¦æŠ“å–æ¬„ä½
            return {
                year: String(row['å­¸å¹´åº¦'] || row['year'] || "").trim(),
                sem: String(row['å­¸æœŸ'] || row['semester'] || "").trim(),
                code: String(row['é¸èª²ä»£è™Ÿ'] || row['code'] || "").trim(),
                name: String(row['ç§‘ç›®åç¨±'] || row['name'] || "").trim(),
                credit: parseFloat(row['å­¸åˆ†'] || row['credits'] || 0),
                gpa: String(row['GPA'] || row['gpa'] || "").trim()
            };
        }).filter(item => item.year && item.name); // éæ¿¾ç©ºè¡Œ
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const result = [];
        // å‡è¨­ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œï¼Œè·³é
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if(!line) continue;
            const cols = line.split(',');
            if (cols.length >= 6) {
                result.push({
                    year: cols[0].trim(),
                    sem: cols[1].trim(),
                    code: cols[2].trim(),
                    name: cols[3].trim(),
                    credit: parseFloat(cols[4]),
                    gpa: cols[5].trim()
                });
            }
        }
        return result;
    }

    // --- 4. æ ¸å¿ƒåˆ†æé‚è¼¯ ---
    function analyze() {
        if (parsedStudentData.length === 0) {
            alert("æ²’æœ‰å¯åˆ†æçš„è³‡æ–™");
            return;
        }

        const year = document.getElementById('admissionYear').value;
        const rule = RULES[year];
        
        // è®Šæ•¸æ­¸é›¶
        let credits = { req: 0, elec: 0, gen: 0, total: 0 };
        let resultLists = { req: [], elec: [], gen: [], fail: [] };

        // å»ºç«‹å¿…ä¿®æª¢æŸ¥æ¸…å–® (æ·±æ‹·è²)
        let reqCheckList = rule.subjects.map(s => ({ ...s, matched: false, log: null }));

        // é–‹å§‹éæ­·å­¸ç”Ÿä¿®èª²ç´€éŒ„
        parsedStudentData.forEach(record => {
            // 1. åˆ¤æ–·åŠæ ¼ (åªæœ‰ A+, A, A-, B+, B, B-, C+, C, C- ç®—é)
            // ä½¿ç”¨è€…å¼·èª¿ï¼šD ç‚ºä¸åŠæ ¼
            const passGrades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-'];
            const isPass = passGrades.includes(record.gpa);

            // è™•ç†å­¸æœŸè½‰æ› (ä¸Š/ä¸‹ -> 1/2)
            let semDigit = record.sem;
            if (semDigit === 'ä¸Š') semDigit = '1';
            if (semDigit === 'ä¸‹') semDigit = '2';

            if (!isPass) {
                resultLists.fail.push(record);
                return; // ä¸åŠæ ¼ä¸è¨ˆå…¥ä»»ä½•å­¸åˆ†
            }

            // 2. åˆ¤æ–·åˆ†é¡
            let category = "General"; // é è¨­

            // A. ä¾‹å¤–ç®¡ç†å„ªå…ˆ
            if (exceptionMap[record.code]) {
                category = exceptionMap[record.code];
            } else {
                // B. æ¯”å°ç³»å¿…ä¿®
                let isReq = false;
                for (let r of reqCheckList) {
                    // æ¯”å°ä»£ç¢¼ æˆ– åç¨±(å»é™¤æ‹¬è™Ÿ)
                    const recNameClean = record.name.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, "").trim();
                    const reqNameClean = r.name.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, "").trim();
                    
                    // é‚è¼¯ï¼šä»£ç¢¼å»åˆ OR åç¨±åŒ…å«ä¸”å°šæœªæŠµå…
                    if ( (r.codes.includes(record.code) || record.name.includes(reqNameClean)) && !r.matched ) {
                        r.matched = true;
                        r.log = record;
                        isReq = true;
                        break;
                    }
                }
                if (isReq) category = "Required";
                else {
                    // C. åˆ¤æ–·ç³»é¸ä¿® (æŸ¥è©¢ CourseDB)
                    const dbKey = `${record.year}-${semDigit}-${record.code}`;
                    const courseInfo = courseDatabase[dbKey];
                    
                    // åˆ¤æ–·é‚è¼¯ï¼š
                    // 1. è‹¥è³‡æ–™åº«æœ‰è©²èª²ï¼Œä¸”é–‹èª²å–®ä½ä»£ç¢¼(å‡è¨­)åŒ…å«é›»æ©Ÿç³»
                    //    (å› ç„¡æ³•å¾—çŸ¥ç¢ºåˆ‡ä»£ç¢¼ï¼Œé€™è£¡æ”¹ç”¨åç¨±åˆ¤æ–·æ³•åš Fallback)
                    // 2. è‹¥èª²åçœ‹èµ·ä¾†åƒå°ˆæ¥­èª²ç¨‹ (ä¸å«é€šè­˜ã€é«”è‚²ç­‰é—œéµå­—)
                    const nonDeptKeywords = ["é€šè­˜", "é«”è‚²", "åœ‹é˜²", "ä¸­æ–‡", "è‹±æ–‡", "æ­·å²", "åšé›…"];
                    let isLikelyDept = true;
                    for (let k of nonDeptKeywords) {
                        if (record.name.includes(k)) isLikelyDept = false;
                    }

                    if (isLikelyDept) category = "Elective";
                    else category = "General";
                }
            }

            // 3. çµ±è¨ˆ
            if (category === "Required") {
                credits.req += record.credit;
                resultLists.req.push(record);
            } else if (category === "Elective") {
                credits.elec += record.credit;
                resultLists.elec.push(record);
            } else {
                credits.gen += record.credit;
                resultLists.gen.push(record);
            }
            credits.total += record.credit;
        });

        // 4. æ¸²æŸ“ UI
        updateUI(credits, resultLists, reqCheckList);
    }

    function updateUI(credits, lists, reqCheckList) {
        document.getElementById('result-section').classList.remove('hidden');
        
        // æ›´æ–°æ•¸å­—å¡ç‰‡
        document.getElementById('reqCredits').innerText = credits.req;
        document.getElementById('elecCredits').innerText = credits.elec;
        document.getElementById('genCredits').innerText = credits.gen;
        document.getElementById('totalCredits').innerText = credits.total;

        const passedCount = reqCheckList.filter(r => r.matched).length;
        document.getElementById('reqRate').innerText = Math.round((passedCount / reqCheckList.length) * 100) + "%";

        // æ›´æ–°è¡¨æ ¼
        const container = document.getElementById('tables-container');
        let html = "";

        // è¡¨ 1: å¿…ä¿®æ ¸å°è¡¨
        html += `<h4>ğŸ“Œ ç³»å¿…ä¿®æ ¸å°ç‹€æ³</h4>
        <table>
            <thead><tr><th>å¿…ä¿®ç§‘ç›®</th><th>è¦å®šå­¸åˆ†</th><th>ç‹€æ…‹</th><th>æŠµå…èª²ç¨‹</th></tr></thead>
            <tbody>`;
        reqCheckList.forEach(r => {
            const status = r.matched ? '<span class="pass">å·²ä¿®ç¿’</span>' : '<span class="fail">æœªä¿®ç¿’</span>';
            const detail = r.log ? `${r.log.year}-${r.log.sem} | ${r.log.name} (${r.log.gpa})` : "-";
            html += `<tr><td>${r.name}</td><td>${r.credits}</td><td>${status}</td><td>${detail}</td></tr>`;
        });
        html += `</tbody></table><br>`;

        // è¡¨ 2: ç³»é¸ä¿®
        html += `<h4>ğŸ“˜ ç³»é¸ä¿® (${credits.elec} å­¸åˆ†)</h4>${renderCourseTable(lists.elec)}`;

        // è¡¨ 3: é€šè­˜/å…¶ä»–
        html += `<h4>ğŸŒ é€šè­˜èˆ‡å…¶ä»– (${credits.gen} å­¸åˆ†)</h4>${renderCourseTable(lists.gen)}`;

        // è¡¨ 4: ä¸åŠæ ¼
        html += `<h4 style="color:#dc3545">âŒ ä¸åŠæ ¼ / æœªé€šé</h4>${renderCourseTable(lists.fail)}`;

        container.innerHTML = html;
    }

    function renderCourseTable(list) {
        if (list.length === 0) return "<p style='color:#666; font-size:14px;'>ç„¡è³‡æ–™</p>";
        let h = `<table><thead><tr><th>å­¸å¹´æœŸ</th><th>ä»£ç¢¼</th><th>èª²å</th><th>å­¸åˆ†</th><th>GPA</th></tr></thead><tbody>`;
        list.forEach(c => {
            h += `<tr><td>${c.year}-${c.sem}</td><td>${c.code}</td><td>${c.name}</td><td>${c.credit}</td><td>${c.gpa}</td></tr>`;
        });
        h += `</tbody></table><br>`;
        return h;
    }

    function reAnalyzeIfReady() {
        if (parsedStudentData.length > 0) analyze();
    }

    // --- 5. ç®¡ç†è€…åŠŸèƒ½ ---
    function toggleAdmin() {
        const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼š");
        if (pwd === "07160330") {
            document.getElementById('admin-panel').style.display = 'block';
            alert("ç®¡ç†è€…ç™»å…¥æˆåŠŸï¼ä¸‹æ–¹ä¾‹å¤–ç®¡ç†é¢æ¿å·²å•Ÿç”¨ã€‚");
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        }
    }

    function addException() {
        const code = document.getElementById('exCode').value.trim();
        const type = document.getElementById('exType').value;
        const typeNameMap = { "Required": "ç³»å¿…ä¿®", "Elective": "ç³»é¸ä¿®", "General": "é€šè­˜/å…¶ä»–" };
        
        if (!code) return alert("è«‹è¼¸å…¥é¸èª²ä»£è™Ÿ");

        // æ–°å¢è¦å‰‡
        exceptionMap[code] = type;

        // æ›´æ–° UI æ¸…å–®
        const list = document.getElementById('exceptionList');
        if (list.querySelector('li').innerText === "(å°šç„¡è¦å‰‡)") list.innerHTML = "";
        
        const li = document.createElement('li');
        li.innerHTML = `<strong>${code}</strong> âœ ${typeNameMap[type]} <button onclick="removeException(this, '${code}')" style="margin-left:10px; cursor:pointer; color:red; border:none; background:none;">[åˆªé™¤]</button>`;
        list.appendChild(li);

        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('exCode').value = "";

        // ç«‹å³é‡æ–°åˆ†æ
        if (parsedStudentData.length > 0) {
            analyze();
            alert(`è¦å‰‡å·²æ‡‰ç”¨ï¼š${code} ç¾åœ¨è¦–ç‚º ${typeNameMap[type]}`);
        }
    }

    function removeException(btn, code) {
        delete exceptionMap[code];
        btn.parentElement.remove();
        if (parsedStudentData.length > 0) analyze();
    }
</script>

</body>
</html>
